(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{423:function(t,e,r){t.exports=r.p+"assets/img/goal.6e03abe2.png"},424:function(t,e,r){t.exports=r.p+"assets/img/onpremise.f1d33cab.png"},425:function(t,e,r){t.exports=r.p+"assets/img/deploytoazure.e0e5d477.png"},426:function(t,e,r){t.exports=r.p+"assets/img/vpnLabAzureStart.6306c9ad.png"},427:function(t,e,r){t.exports=r.p+"assets/img/vpnGWPIP.ef0fe4eb.png"},428:function(t,e,r){t.exports=r.p+"assets/img/connectionFlow.8657ae70.png"},429:function(t,e,r){t.exports=r.p+"assets/img/vpn0.b2dfe067.png"},430:function(t,e,r){t.exports=r.p+"assets/img/vpn1.ceece175.png"},431:function(t,e,r){t.exports=r.p+"assets/img/vpn2.c2bae65a.png"},432:function(t,e,r){t.exports=r.p+"assets/img/vpn3.5e26f77c.png"},433:function(t,e,r){t.exports=r.p+"assets/img/vpn4.9caf3813.png"},434:function(t,e,r){t.exports=r.p+"assets/img/vpn5.dad472fd.png"},435:function(t,e,r){t.exports=r.p+"assets/img/successfulPing.96d6310b.png"},436:function(t,e,r){t.exports=r.p+"assets/img/vpn6-moresecure.5fa353ef.png"},776:function(t,e,r){"use strict";r.r(e);var a=r(42),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"challenge-8-networking-vpn-enabling-hybrid-networking-with-a-site-2-site-onprem-to-azure-vpn-connection"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#challenge-8-networking-vpn-enabling-hybrid-networking-with-a-site-2-site-onprem-to-azure-vpn-connection"}},[t._v("#")]),t._v(" Challenge 8: Networking - VPN: Enabling Hybrid Networking with a Site-2-Site (Onprem to Azure) VPN Connection")]),t._v(" "),a("h2",{attrs:{id:"here-is-what-you-will-learn"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#here-is-what-you-will-learn"}},[t._v("#")]),t._v(" Here is what you will learn")]),t._v(" "),a("p",[t._v("What it takes to implement a VPN tunnel between your onprem firewall <---VPN S2S---\x3e Azure"),a("br"),t._v(" "),a("strong",[t._v("Our final architecture will look like this")]),t._v(":"),a("br"),t._v(" "),a("img",{attrs:{src:r(423),alt:"Hybrid Network with Azure"}})]),t._v(" "),a("p",[a("strong",[t._v("An Azure S2S VPN requires:")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("onprem")]),t._v(" "),a("th",[t._v("Azure")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("A supported device Azure can talk to.")]),t._v(" "),a("td",[a("ul",[a("li",[t._v("VPN Gateway in its own subnet.")]),a("li",[t._v("VPN GWay requires a dynamic Public IP")]),a("li",[t._v("Settings how the onprem VPN / FWall is to be contacted (aka LocalNetworkGateway)")]),a("li",[t._v("Connection Object with e.g. shared key")])])])])])]),t._v(" "),a("h2",{attrs:{id:"table-of-contents"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#table-of-contents"}},[t._v("#")]),t._v(" Table of Contents")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"#Starting-Point"}},[t._v("Starting Point")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#Create-a-VPN-Gateway-and-a-Public-IP-using-the-portal"}},[t._v("Create a VPN Gateway and a Public IP using the portal")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#Create-a-Local-Network-Gateway"}},[t._v("[Azure] Create a Local Network Gateway")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#Create-a-connection-object-with-shared-key"}},[t._v("[Azure] Create a connection object with shared key")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#Configure-your-onpremise-VPN-counterpart-e.g.-ipfire"}},[t._v("[Onpremise] Configure your onpremise VPN counterpart e.g. ipfire")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#Cleanup"}},[t._v("Cleanup")])])]),t._v(" "),a("h1",{attrs:{id:"starting-point"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#starting-point"}},[t._v("#")]),t._v(" Starting Point")]),t._v(" "),a("p",[t._v("Your "),a("strong",[t._v("instructor")]),t._v(" ("),a("em",[t._v("ask him for the details")]),t._v(") "),a("strong",[t._v("has setup for you the onprem")]),t._v(" part:"),a("br"),t._v(" "),a("img",{attrs:{src:r(424),alt:"Onpremise"}})]),t._v(" "),a("p",[a("strong",[t._v("Click")]),t._v(" on the\n"),a("a",{attrs:{href:"https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fazuredevcollege%2Ftrainingdays%2Fmaster%2Fday1%2Fchallenge-08%2Fchallengestart%2Fchallengestart.json"}},[a("img",{attrs:{src:r(425)}})]),t._v("\nbutton "),a("strong",[t._v("to get the Azure resources to start")]),t._v(" with:"),a("br"),t._v(" "),a("img",{attrs:{src:r(426),alt:"azure vpn starting point"}})]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Name")]),t._v(" "),a("th",[t._v("Value")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Resource group")]),t._v(" "),a("td",[a("strong",[t._v("(new)")]),t._v(" rg-vpn")])]),t._v(" "),a("tr",[a("td",[t._v("Location")]),t._v(" "),a("td",[a("strong",[t._v("North Europe")])])]),t._v(" "),a("tr",[a("td",[t._v("Admin user")]),t._v(" "),a("td",[t._v("demouser")])]),t._v(" "),a("tr",[a("td",[t._v("Admin password")]),t._v(" "),a("td",[a("strong",[a("em",[t._v("some complex value")])])])]),t._v(" "),a("tr",[a("td",[t._v("Vm Size")]),t._v(" "),a("td",[a("strong",[t._v("Standard_B2s")]),t._v("  or try e.g. "),a("strong",[t._v("Standard_F2s_v2")])])]),t._v(" "),a("tr",[a("td",[t._v("Disk Sku")]),t._v(" "),a("td",[t._v("StandardSSD_LRS")])])])]),t._v(" "),a("h1",{attrs:{id:"create-a-vpn-gateway-and-a-public-ip-using-the-portal"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-vpn-gateway-and-a-public-ip-using-the-portal"}},[t._v("#")]),t._v(" Create a VPN Gateway and a Public IP using the portal")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[Azure Portal] -> '+ Create a resource' -> type \"Virtual network gateway\"\n  -> Create\n")])])]),a("p",[a("strong",[t._v("Use the following parameter values")]),t._v(":")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Parameter Name")]),t._v(" "),a("th",[t._v("Values")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Name")]),t._v(" "),a("td",[a("strong",[t._v("myAzVPNGWay")])])]),t._v(" "),a("tr",[a("td",[t._v("Region")]),t._v(" "),a("td",[a("strong",[t._v("North Europe")])])]),t._v(" "),a("tr",[a("td",[t._v("Gateway type")]),t._v(" "),a("td",[t._v("VPN")])]),t._v(" "),a("tr",[a("td",[t._v("VPN Type")]),t._v(" "),a("td",[t._v("Route based")])]),t._v(" "),a("tr",[a("td",[t._v("Gateway type")]),t._v(" "),a("td",[t._v("VPN")])]),t._v(" "),a("tr",[a("td",[t._v("SKU")]),t._v(" "),a("td",[t._v("VpnGw1")])]),t._v(" "),a("tr",[a("td",[t._v("Virtual Network")]),t._v(" "),a("td",[a("strong",[t._v("vnet-vpn")])])]),t._v(" "),a("tr",[a("td",[t._v("Gateway subnet address range")]),t._v(" "),a("td",[t._v("e.g. "),a("strong",[t._v("10.1.254.192/26")])])]),t._v(" "),a("tr",[a("td",[t._v("Public IP address")]),t._v(" "),a("td",[a("strong",[t._v("Create new")])])]),t._v(" "),a("tr",[a("td",[t._v("Public IP address name")]),t._v(" "),a("td",[a("strong",[t._v("myAzVPNGWay-IP")])])]),t._v(" "),a("tr",[a("td",[t._v("Enable active-active mode")]),t._v(" "),a("td",[t._v("Disabled")])]),t._v(" "),a("tr",[a("td",[t._v("Configure BGP")]),t._v(" "),a("td",[t._v("Disabled")])])])]),t._v(" "),a("p",[a("strong",[t._v("The GW setup will take approx 30 mins. to create")]),t._v(" -> come back later (e.g. in the meantime you can do the next lab ðŸ˜ƒ)..."),a("br"),t._v("\nWhen your "),a("strong",[t._v("GW has")]),t._v(" been assigned a "),a("strong",[t._v("public IP")]),t._v(" address then you know "),a("strong",[t._v("it is online")]),t._v("."),a("br"),t._v(" "),a("img",{attrs:{src:r(427),alt:"VPN GW with public IP"}})]),t._v(" "),a("h1",{attrs:{id:"create-a-local-network-gateway"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-local-network-gateway"}},[t._v("#")]),t._v(" Create a Local Network Gateway")]),t._v(" "),a("p",[t._v("The purpose of this task is to tell azure how to contact the onpremise firewall:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[Azure Portal] -> '+ Add' -> type 'Local network gateway' -> Create\n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("Parameter Name")]),t._v(" "),a("th",[t._v("Values")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Name")]),t._v(" "),a("td",[a("strong",[t._v("l-gw-ipfire")])])]),t._v(" "),a("tr",[a("td",[t._v("IP address")]),t._v(" "),a("td",[a("strong",[a("em",[t._v("%external IP of your Firewall - ask instructor%")])])])]),t._v(" "),a("tr",[a("td",[t._v("Address Space")]),t._v(" "),a("td",[a("strong",[t._v("192.168.0.0/24")])])]),t._v(" "),a("tr",[a("td",[t._v("Resource Group")]),t._v(" "),a("td",[a("strong",[t._v("rg-vpn")])])]),t._v(" "),a("tr",[a("td",[t._v("Location")]),t._v(" "),a("td",[a("strong",[t._v("North Europe")])])])])]),t._v(" "),a("h1",{attrs:{id:"create-a-connection-object-with-shared-key"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-connection-object-with-shared-key"}},[t._v("#")]),t._v(" Create a connection object with shared key")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[Azure Portal] -> Resource Groups -> rg-vpn -> myAzVPNGWay\n -> Connections -> \n")])])]),a("table",[a("thead",[a("tr",[a("th",[t._v("Parameter Name")]),t._v(" "),a("th",[t._v("Values")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Name")]),t._v(" "),a("td",[a("strong",[t._v("azure-to-onprem")])])]),t._v(" "),a("tr",[a("td",[t._v("Connection Type")]),t._v(" "),a("td",[a("strong",[t._v("Site-to-Site (IPSec)")])])]),t._v(" "),a("tr",[a("td",[t._v("Virtual Network Gateway")]),t._v(" "),a("td",[a("strong",[t._v("myAzVPNGWay")])])]),t._v(" "),a("tr",[a("td",[t._v("Local Network Gateway")]),t._v(" "),a("td",[a("strong",[t._v("l-gw-ipfire")])])]),t._v(" "),a("tr",[a("td",[t._v("Shared Key")]),t._v(" "),a("td",[t._v("*********** (your choice here)")])]),t._v(" "),a("tr",[a("td",[t._v("IKE Protocol")]),t._v(" "),a("td",[t._v("IKEv2")])]),t._v(" "),a("tr",[a("td",[t._v("Resource Group")]),t._v(" "),a("td",[t._v("rg-vpn")])]),t._v(" "),a("tr",[a("td",[t._v("Location")]),t._v(" "),a("td",[t._v("North Europe")])])])]),t._v(" "),a("h1",{attrs:{id:"configure-your-onpremise-vpn-counterpart-e-g-ipfire"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configure-your-onpremise-vpn-counterpart-e-g-ipfire"}},[t._v("#")]),t._v(" Configure your onpremise VPN counterpart e.g. ipfire")]),t._v(" "),a("p",[a("strong",[t._v("We now need to configure the other end of the vpn tunnel")]),t._v(": "),a("strong",[a("em",[t._v("the onpremise firewall")])]),t._v(" in our case a linux FW called "),a("em",[t._v("IPFire")]),t._v(".")]),t._v(" "),a("p",[a("strong",[t._v("1. For this use the remote desktop client to RDP into your onpremise environment")]),t._v(":")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Internet -- 1st RDP--\x3e onprem Lab (HyperV Host) -- 2nd RDP--\x3e cmW2k19 (192.168.0.11) --https--\x3eIPFire (192.168.0.100)  \n")])])]),a("p",[a("img",{attrs:{src:r(428),alt:"Connection Flow"}})]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Parameter Name")]),t._v(" "),a("th",[t._v("Values")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("connect to"),a("br"),t._v("1st RDP")]),t._v(" "),a("td",[a("ul",[a("li",[a("b",[t._v("IP")]),t._v(": %ask instructor%")]),a("li",[a("b",[t._v("username")]),t._v(": demouser")]),a("li",[a("b",[t._v("password")]),t._v(": %ask instructor%")])])])]),t._v(" "),a("tr",[a("td",[t._v("within this session connect to"),a("br"),t._v("2nd RDP")]),t._v(" "),a("td",[a("ul",[a("li",[a("b",[t._v("IP")]),t._v(": 192.168.0.11")]),a("li",[a("b",[t._v("username")]),t._v(": administrator")]),a("li",[a("b",[t._v("password")]),t._v(": %ask instructor%")])])])]),t._v(" "),a("tr",[a("td",[t._v("open browser an do https"),a("br"),t._v("( ignore certificate warning -> proceed)")]),t._v(" "),a("td",[a("ul",[a("li",[a("b",[t._v("URI")]),t._v(": https://192.168.0.100:444")]),a("li",[a("b",[t._v("username")]),t._v(": admin")]),a("li",[a("b",[t._v("password")]),t._v(": %ask instructor%")])])])])])]),t._v(" "),a("blockquote",[a("p",[t._v("Note: "),a("strong",[a("em",[t._v("ask your instructor for connection details")])])])]),t._v(" "),a("p",[a("strong",[t._v("2. Add the VPN details")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("   IPFire -> Services -> IPSec -> 'Connection Status and -Control' -> Add\n")])])]),a("p",[a("img",{attrs:{src:r(429),alt:"IPFire: Add a connection"}})]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('   "Net-to-Net Virtual Private Network" -> Add\n')])])]),a("p",[a("img",{attrs:{src:r(430),alt:"IPFire: add Net-to-Net connection"}})]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Parameter Name")]),t._v(" "),a("th",[t._v("Values")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Name")]),t._v(" "),a("td",[a("strong",[t._v("azure")])])]),t._v(" "),a("tr",[a("td",[t._v("Local subnet")]),t._v(" "),a("td",[t._v("192.168.0.0/255.255.255.0")])]),t._v(" "),a("tr",[a("td",[t._v("Remote Host/IP")]),t._v(" "),a("td",[a("em",[a("strong",[t._v("%myAzVPNGWay IP Address%")])]),t._v("  (Azure Portal -> VPN Gateway -> Public IP address)")])]),t._v(" "),a("tr",[a("td",[t._v("Remote subnet")]),t._v(" "),a("td",[a("strong",[a("em",[t._v("%Address Range of the virtual network in azure%")])]),t._v(" (in our case 10.1.0.0/255.255.0.0)")])]),t._v(" "),a("tr",[a("td",[t._v("Use a pre-shared key")]),t._v(" "),a("td",[a("strong",[a("em",[t._v("%Shared Key you used above%")])]),t._v(" (Azure Portal -> VPN Gateway -> Connections -> Shared Key)")])])])]),t._v(" "),a("p",[a("img",{attrs:{src:r(431),alt:"IPFire: connection settings"}}),t._v(" "),a("strong",[t._v("Save")])]),t._v(" "),a("p",[a("strong",[t._v("3. Modify the algorithms used for the connection")]),a("br"),t._v(" "),a("strong",[t._v("Click on the pencil symbol and choose 'Advanced'")]),t._v(":\n"),a("img",{attrs:{src:r(432),alt:"IPFire: Advanced cipher settings"}})]),t._v(" "),a("p",[a("strong",[t._v("You must")]),t._v(" (!) select the "),a("strong",[t._v("following algorithms / suites for the connection")]),t._v(":")]),t._v(" "),a("p",[a("img",{attrs:{src:r(433),alt:"IPFire: connection settings"}}),a("br"),t._v(" "),a("strong",[t._v("select Always on")]),t._v(" then "),a("strong",[t._v("Save")])]),t._v(" "),a("p",[a("strong",[t._v("Tick checkbox to enable connection")]),t._v(" - connection status should go to green:\n"),a("img",{attrs:{src:r(434),alt:"IPFire: connection settings"}})]),t._v(" "),a("p",[a("strong",[t._v("Now let's ping your azure vm")]),t._v(" (e.g. vmazure) under its private ip (probably: 10.1.0.4) from onpremise:"),a("br"),t._v(" "),a("img",{attrs:{src:r(435),alt:"Successful Ping"}}),t._v("\nDo you receive a response?")]),t._v(" "),a("h2",{attrs:{id:"optional-apply-a-more-secure-cipher-for-the-vpn-tunnel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#optional-apply-a-more-secure-cipher-for-the-vpn-tunnel"}},[t._v("#")]),t._v(" [Optional] Apply a more secure cipher for the VPN tunnel.")]),t._v(" "),a("p",[a("strong",[t._v("The following ARM Template ("),a("a",{attrs:{href:"./VPNMoreSecureConnPolicy.json"}},[t._v("VPNMoreSecureConnPolicy.json")]),t._v(") defines a more secure cipher / algorithm to use for the VPN tunnel.")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Parameter Name")]),t._v(" "),a("th",[t._v("Values")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("ipsecEncryption")]),t._v(" "),a("td",[t._v("AES256")])]),t._v(" "),a("tr",[a("td",[t._v("ipsecIntegrity")]),t._v(" "),a("td",[t._v("SHA256")])]),t._v(" "),a("tr",[a("td",[t._v("ikeEncryption")]),t._v(" "),a("td",[t._v("AES256")])]),t._v(" "),a("tr",[a("td",[t._v("ikeIntegrity")]),t._v(" "),a("td",[t._v("SHA384")])]),t._v(" "),a("tr",[a("td",[t._v("dhGroup")]),t._v(" "),a("td",[t._v("DHGroup14")])]),t._v(" "),a("tr",[a("td",[t._v("pfsGroup")]),t._v(" "),a("td",[t._v("PFS2048")])])])]),t._v(" "),a("p",[t._v("To deploy click the\n"),a("a",{attrs:{href:"https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fazuredevcollege%2Ftrainingdays%2Fmaster%2Fday1%2Fchallenges%2FChallenge8%2FVPNMoreSecureConnPolicy.json"}},[a("img",{attrs:{src:"deploytoazure.png"}})]),t._v("\nbutton and select correct parameters to apply new ciphers to your current connection."),a("br"),t._v("\nHowever you also need to apply this to the onprem firewall:"),a("br"),t._v(" "),a("img",{attrs:{src:r(436),alt:"VPN more secure cipher"}})]),t._v(" "),a("h1",{attrs:{id:"cleanup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cleanup"}},[t._v("#")]),t._v(" Cleanup")]),t._v(" "),a("p",[a("strong",[t._v("Delete the resource group")]),t._v(" "),a("em",[t._v("rg-vpn")])])])}),[],!1,null,null,null);e.default=n.exports}}]);