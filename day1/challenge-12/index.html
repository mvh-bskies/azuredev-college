<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Challenge 12: Azure Automation: Send me yesterday&#39;s Azure cost. | Azure Developer College</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/trainingdays/assets/css/0.styles.bc728db4.css" as="style"><link rel="preload" href="/trainingdays/assets/js/app.d38bf813.js" as="script"><link rel="preload" href="/trainingdays/assets/js/2.5ff1d4d5.js" as="script"><link rel="preload" href="/trainingdays/assets/js/8.240e2339.js" as="script"><link rel="prefetch" href="/trainingdays/assets/js/10.e0433817.js"><link rel="prefetch" href="/trainingdays/assets/js/11.cd8c7b17.js"><link rel="prefetch" href="/trainingdays/assets/js/12.12888c30.js"><link rel="prefetch" href="/trainingdays/assets/js/13.873bda65.js"><link rel="prefetch" href="/trainingdays/assets/js/14.1a24ee27.js"><link rel="prefetch" href="/trainingdays/assets/js/15.6fa51cf9.js"><link rel="prefetch" href="/trainingdays/assets/js/16.d5e02596.js"><link rel="prefetch" href="/trainingdays/assets/js/17.fcaa5f26.js"><link rel="prefetch" href="/trainingdays/assets/js/18.f2a21d28.js"><link rel="prefetch" href="/trainingdays/assets/js/19.a350c78d.js"><link rel="prefetch" href="/trainingdays/assets/js/20.bfd694b1.js"><link rel="prefetch" href="/trainingdays/assets/js/21.bed10b37.js"><link rel="prefetch" href="/trainingdays/assets/js/22.860246de.js"><link rel="prefetch" href="/trainingdays/assets/js/23.b225110a.js"><link rel="prefetch" href="/trainingdays/assets/js/24.13b22772.js"><link rel="prefetch" href="/trainingdays/assets/js/25.e0f5a7a3.js"><link rel="prefetch" href="/trainingdays/assets/js/26.c1146b2a.js"><link rel="prefetch" href="/trainingdays/assets/js/27.ab26807b.js"><link rel="prefetch" href="/trainingdays/assets/js/28.ab2698cc.js"><link rel="prefetch" href="/trainingdays/assets/js/29.496ec42d.js"><link rel="prefetch" href="/trainingdays/assets/js/3.b5657a11.js"><link rel="prefetch" href="/trainingdays/assets/js/30.fd15c623.js"><link rel="prefetch" href="/trainingdays/assets/js/31.72ed4ad1.js"><link rel="prefetch" href="/trainingdays/assets/js/32.81e15b13.js"><link rel="prefetch" href="/trainingdays/assets/js/33.f1fcf176.js"><link rel="prefetch" href="/trainingdays/assets/js/34.8432e852.js"><link rel="prefetch" href="/trainingdays/assets/js/35.61413aac.js"><link rel="prefetch" href="/trainingdays/assets/js/36.dc009a95.js"><link rel="prefetch" href="/trainingdays/assets/js/37.88c251fb.js"><link rel="prefetch" href="/trainingdays/assets/js/38.b9f64ed2.js"><link rel="prefetch" href="/trainingdays/assets/js/39.4bf7d432.js"><link rel="prefetch" href="/trainingdays/assets/js/4.316442a1.js"><link rel="prefetch" href="/trainingdays/assets/js/40.a1779f5a.js"><link rel="prefetch" href="/trainingdays/assets/js/41.b4f159db.js"><link rel="prefetch" href="/trainingdays/assets/js/42.096f1aa1.js"><link rel="prefetch" href="/trainingdays/assets/js/43.cf13395f.js"><link rel="prefetch" href="/trainingdays/assets/js/44.92be7e22.js"><link rel="prefetch" href="/trainingdays/assets/js/45.298ad7f7.js"><link rel="prefetch" href="/trainingdays/assets/js/46.4d6179b3.js"><link rel="prefetch" href="/trainingdays/assets/js/47.bc41cef1.js"><link rel="prefetch" href="/trainingdays/assets/js/48.31275a9a.js"><link rel="prefetch" href="/trainingdays/assets/js/49.a2dc55f9.js"><link rel="prefetch" href="/trainingdays/assets/js/5.815c1276.js"><link rel="prefetch" href="/trainingdays/assets/js/50.c6016f95.js"><link rel="prefetch" href="/trainingdays/assets/js/51.0bd2785b.js"><link rel="prefetch" href="/trainingdays/assets/js/52.4e12987f.js"><link rel="prefetch" href="/trainingdays/assets/js/53.fb7850b1.js"><link rel="prefetch" href="/trainingdays/assets/js/54.1f20c333.js"><link rel="prefetch" href="/trainingdays/assets/js/55.d1950d56.js"><link rel="prefetch" href="/trainingdays/assets/js/56.3a6b8119.js"><link rel="prefetch" href="/trainingdays/assets/js/57.3639003b.js"><link rel="prefetch" href="/trainingdays/assets/js/58.091b6b2a.js"><link rel="prefetch" href="/trainingdays/assets/js/59.b1b6f798.js"><link rel="prefetch" href="/trainingdays/assets/js/6.6bc81206.js"><link rel="prefetch" href="/trainingdays/assets/js/60.8312cc43.js"><link rel="prefetch" href="/trainingdays/assets/js/61.8077d507.js"><link rel="prefetch" href="/trainingdays/assets/js/62.7099a9ec.js"><link rel="prefetch" href="/trainingdays/assets/js/63.de9324f4.js"><link rel="prefetch" href="/trainingdays/assets/js/64.69b552bd.js"><link rel="prefetch" href="/trainingdays/assets/js/65.7999d6d6.js"><link rel="prefetch" href="/trainingdays/assets/js/66.bd4052c9.js"><link rel="prefetch" href="/trainingdays/assets/js/67.e79e194c.js"><link rel="prefetch" href="/trainingdays/assets/js/68.f8d8015a.js"><link rel="prefetch" href="/trainingdays/assets/js/69.e5994ee8.js"><link rel="prefetch" href="/trainingdays/assets/js/7.60b45c24.js"><link rel="prefetch" href="/trainingdays/assets/js/70.55b1b75a.js"><link rel="prefetch" href="/trainingdays/assets/js/71.eba7950f.js"><link rel="prefetch" href="/trainingdays/assets/js/72.75c0fa4d.js"><link rel="prefetch" href="/trainingdays/assets/js/73.457d78aa.js"><link rel="prefetch" href="/trainingdays/assets/js/74.a278da89.js"><link rel="prefetch" href="/trainingdays/assets/js/75.8f7da85a.js"><link rel="prefetch" href="/trainingdays/assets/js/76.306b2367.js"><link rel="prefetch" href="/trainingdays/assets/js/77.4b93f5b5.js"><link rel="prefetch" href="/trainingdays/assets/js/78.149c6cba.js"><link rel="prefetch" href="/trainingdays/assets/js/79.df492d10.js"><link rel="prefetch" href="/trainingdays/assets/js/80.91573785.js"><link rel="prefetch" href="/trainingdays/assets/js/9.6caa67cc.js">
    <link rel="stylesheet" href="/trainingdays/assets/css/0.styles.bc728db4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/trainingdays/" class="home-link router-link-active"><!----> <span class="site-name">Azure Developer College</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/trainingdays/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/trainingdays/day1/" aria-current="page" class="sidebar-link">Day 1 Azure Fundamentals &amp; Infrastructure</a></li><li><a href="/trainingdays/day2/" class="sidebar-link">Day 2 Azure Development</a></li><li><a href="/trainingdays/day3/" class="sidebar-link">Day 3 Data and AI</a></li><li><a href="/trainingdays/day4/" class="sidebar-link">Day 4 Azure DevOps</a></li><li><a href="/trainingdays/day5/" class="sidebar-link">Day 5 Identity and Architecture</a></li><li><a href="/trainingdays/day6/" class="sidebar-link">Day 6 Containerization</a></li><li><a href="/trainingdays/day7/" class="sidebar-link">Day 7 Kubernetes</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="challenge-12-azure-automation-send-me-yesterday-s-azure-cost"><a href="#challenge-12-azure-automation-send-me-yesterday-s-azure-cost" class="header-anchor">#</a> Challenge 12: Azure Automation: Send me yesterday's Azure cost.</h1> <p>adapted from <a href="https://github.com/bfrankMS/myAzureCost" target="_blank" rel="noopener noreferrer">MyAzure Cost<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> this will send you an email with your daily Azure cost report.</p> <h2 id="here-is-what-you-will-learn"><a href="#here-is-what-you-will-learn" class="header-anchor">#</a> Here is what you will learn</h2> <ul><li>How to use an Azure Automation account with PowerShell runbooks.</li> <li>Get insights in your azure consumption for the day.</li></ul> <h2 id="in-your-inbox-you-ll-get-a-report-each-day-of-the-usage-and-the-costs"><a href="#in-your-inbox-you-ll-get-a-report-each-day-of-the-usage-and-the-costs" class="header-anchor">#</a> In your inbox you'll get a report each day of the usage and the costs:</h2> <table><thead><tr><th><img src="/trainingdays/assets/img/email.1b5ca47a.png" alt="daily email"></th> <th><img src="/trainingdays/assets/img/CostsCSV.c4dbd564.png" alt="cost report"></th></tr></thead> <tbody><tr><td>your <strong>daily cost email</strong> looks similar to this</td> <td>sample <strong>cost report</strong> (as .csv)</td></tr></tbody></table> <p>It'll also contain e.g.</p> <table><thead><tr><th><img src="/trainingdays/assets/img/7DaysHistory.eb85c7b6.png" alt="7days History"></th> <th><img src="/trainingdays/assets/img/CostPerCategory.81b02161.png" alt="Costs Per Category"></th></tr></thead> <tbody><tr><td><strong>historic data</strong> (using an Azure table)</td> <td>Cost Per Category</td></tr></tbody></table> <h2 id="a-look-behind-the-curtain"><a href="#a-look-behind-the-curtain" class="header-anchor">#</a> A look behind the curtain:</h2> <table><thead><tr><th>Architecture</th> <th></th></tr></thead> <tbody><tr><td><img src="/trainingdays/assets/img/architecture.34c498b4.png" alt="Architecture"></td> <td><ul><li>ARM template for setup</li><li>azure automation for daily tasks</li><li>.net code to send email and analysis</li><li>a storage account to hold data</li></ul></td></tr></tbody></table> <h2 id="table-of-contents"><a href="#table-of-contents" class="header-anchor">#</a> Table Of Contents</h2> <ol><li><a href="#Deploy-the-ARM-Template">Deploy the ARM Template</a></li> <li><a href="#Create-an-Azure-Run-As-Account">Create an Azure Run As Account</a></li> <li><a href="#Create-a-Table-and-see-AA-Variables-Section">Create a Table and see AA Variables Section</a></li> <li><a href="#Upload-a-price-sheet">Upload a price sheet</a></li> <li><a href="#Run-a-report">Run a report</a></li></ol> <h1 id="deploy-the-arm-template"><a href="#deploy-the-arm-template" class="header-anchor">#</a> Deploy the ARM Template</h1> <p><strong>Click</strong> on the
<a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fazuredevcollege%2Ftrainingdays%2Fmaster%2Fday1%2Fchallenge-12%2Fchallengestart%2Fchallengestart.json"><img src="/trainingdays/assets/img/deploytoazure.e0e5d477.png"></a>
button.</p> <table><thead><tr><th>Name</th> <th>Values</th></tr></thead> <tbody><tr><td><em>Region</em></td> <td><strong>West Europe</strong></td></tr> <tr><td><em>Resource group</em></td> <td>rg-myAzureCost</td></tr> <tr><td><em>O_my Azure Cost Smtp Recipient</em></td> <td><em>%the destination email address%</em></td></tr> <tr><td><em>O_my Azure Cost Smtp Sender</em></td> <td><em>%the source email / sender address%</em></td></tr> <tr><td><em>O_my Azure Cost Smtp Sender Password</em></td> <td><em>%the email sender's smtp pwd%</em></td></tr> <tr><td><em>O_my Azure Cost Smtp Server</em></td> <td>%the senders smtp server% e.g. <em>smtp.office365.com</em></td></tr> <tr><td><em>O_my Azure Cost Smtp Server SSL Port</em></td> <td>e.g. 587 for smtp.office365.com</td></tr> <tr><td><em>O_base Time</em></td> <td><strong><em>don't touch</em></strong></td></tr></tbody></table> <p><strong>Deployment should take &lt; 10mins.</strong></p> <h1 id="create-an-azure-run-as-account"><a href="#create-an-azure-run-as-account" class="header-anchor">#</a> Create an Azure Run As Account</h1> <p>For Azure Automation (AA) to perform tasks in the current subscription (e.g. gather usage information) needs an account a so called Run As Account. This account is a so called service principal (SP) which has permissions in the current subscription. To create this SP and connect it to AA please do the following:</p> <div class="language- extra-class"><pre class="language-text"><code>[Azure Portal] -&gt; Resource Groups -&gt; &quot;rg-AzureCost&quot; -&gt; 'aaazurecost...' (Your Automation Account) -&gt; Account Settings -&gt; Run as accounts
</code></pre></div><p>Hit <strong>Create</strong>, <strong>wait</strong> and <strong>watch</strong> the account being created:<br> <img src="/trainingdays/assets/img/CreateRunAsAccount.7dd241c8.png" alt="Create AA Run as account"><br>
Note that <strong>this account has an <em>'expiration date'</em></strong>.</p> <h2 id="optional-see-how-the-aa-run-as-account-manifests-itself-throughout-aad-and-your-subscription"><a href="#optional-see-how-the-aa-run-as-account-manifests-itself-throughout-aad-and-your-subscription" class="header-anchor">#</a> [Optional] - See how the AA Run As account manifests itself throughout AAD and your subscription</h2> <table><thead><tr><th><img src="/trainingdays/assets/img/AAManifestations1.54fbdeb7.png" alt="AA Run As is an Azure AD - Application Registration"></th> <th><img src="/trainingdays/assets/img/AAManifestations2.77ea88db.png" alt="...and has contributor rights to your subscription"></th></tr></thead> <tbody><tr><td><code>[Azure Portal] -&gt; Azure Active Directory -&gt; App registrations</code></td> <td><code>[Azure Portal] -&gt; Subscriptions -&gt; Access Control (IAM) -&gt; View role assignments -&gt; 'View'</code></td></tr></tbody></table> <h1 id="create-a-table-and-see-aa-variables-section"><a href="#create-a-table-and-see-aa-variables-section" class="header-anchor">#</a> Create a Table and see AA Variables Section</h1> <p>Storing settings for Azure Automation (AA) e.g. account information, locale settings,... AA credentials and AA variables can be used.
In our myAzureCost sample we use:</p> <ul><li><strong>AA Credentials</strong> to store the <strong>sender's account</strong> details:</li> <li><strong>AA Variables</strong> to hold <strong>settings</strong> <strong>needed</strong> for the AA <strong>Runbooks</strong> that do the usage &amp; cost calculation</li> <li><strong>one Azure table</strong> to <strong>store</strong> processed data e.g. <strong>daily cost history</strong>.</li></ul> <h2 id="_1-inspect-the-variables"><a href="#_1-inspect-the-variables" class="header-anchor">#</a> 1. Inspect the variables</h2> <div class="language- extra-class"><pre class="language-text"><code>[Azure Portal] -&gt; Resource Groups -&gt; &quot;rg-AzureCost&quot; -&gt; 'aaazurecost...' (Your Automation Account) -&gt; Variables
</code></pre></div><table><thead><tr><th>Variable <strong>Name</strong></th> <th><strong>Description</strong></th></tr></thead> <tbody><tr><td>myAzureCostAzureSubscriptionId</td> <td><em><strong>GUID of your subscription</strong> to calculate the usage for</em></td></tr> <tr><td>myAzureCostCultureInfo</td> <td><em>e.g. <strong>de-DE</strong> for reports (CSVs) to come with numbers, date formatted for Germans</em></td></tr> <tr><td>myAzureCostPriceSheetURI</td> <td><em>a URI pointing to a CSV with pricing information about azure resources - we'll take care of this soon</em></td></tr> <tr><td>myAzureCostSAContainer</td> <td><em>where your daily reports are stored - pls don't change</em></td></tr> <tr><td>myAzureCostSATable</td> <td><em>table name to hold your daily usage costs for 'history view'</em></td></tr> <tr><td>myAzureCostSmtpRecipient</td> <td><em>email recipient of the report</em></td></tr> <tr><td>myAzureCostStorageAccountName</td> <td><em>where your daily reports are stored</em></td></tr></tbody></table> <h2 id="_2-create-the-azure-table-to-hold-your-daily-usage-costs-for-history-view"><a href="#_2-create-the-azure-table-to-hold-your-daily-usage-costs-for-history-view" class="header-anchor">#</a> 2. Create the azure table to hold your daily usage costs for 'history view'</h2> <p>There is a <strong>AA Runbook that will create an azure table for us - we only need to start it</strong>:</p> <div class="language- extra-class"><pre class="language-text"><code>[Azure Portal] -&gt; Resource Groups -&gt; &quot;rg-AzureCost&quot; -&gt; 'aaazurecost...' (Your Automation Account) -&gt; &quot;Process Automation&quot; Runbooks -&gt; RunBk_CreateTable -&gt; Start
</code></pre></div><p><img src="/trainingdays/assets/img/CreateTableRunbook.30e294ac.png" alt="Trigger Runbook Create Table"></p> <p>This runbook will execute PowerShell code that creates an Azure table using the AA Runas Account.<br>
A runbook is a piece of code (here PowerShell) that is being executed in an Azure runtime environment. It'll login to your subscription as the Run as Account and perform tasks against your subscription. You can follow the execution by:<br> <img src="/trainingdays/assets/img/FollowRunbookOutput.aa1fc452.png" alt="Follow runbook output"><br>
Once completed you should have a new table in:</p> <div class="language- extra-class"><pre class="language-text"><code>[Azure Portal] -&gt; Resource Groups -&gt; &quot;rg-AzureCost&quot; -&gt; 'azconsumption...' (Your Storage Account) -&gt; Tables
</code></pre></div><p><img src="/trainingdays/assets/img/TableCreated.a7a204c7.png" alt="History costs table created"></p> <h1 id="upload-a-price-sheet"><a href="#upload-a-price-sheet" class="header-anchor">#</a> Upload a price sheet</h1> <p><strong>myAzureCost</strong> can gather your daily consumption data. Additionally it <strong>can</strong> also <strong>estimate</strong> the <strong>costs</strong> that <strong>your consumption will pose</strong>. To do this <strong>you need to upload a price sheet</strong> with your specific azure rates. The price sheet needs to be <strong>formatted as CSV</strong> (en-us) and contain at least 2 columns: <strong>MeterID</strong> and <strong>MeterRates</strong>.</p> <blockquote><p><strong>Annotation</strong>: <strong>Every azure resource in each region has a MeterID</strong> (GUID) that uniquely identifies it. When you query the usage of an azure resource the MeterID is delivered with it. <strong>The MeterID translates to a price</strong> -&gt; MeterRates - e.g.:</p></blockquote> <table><thead><tr><th>MeterId</th> <th>MeterName</th> <th>MeterRates</th> <th>MeterRegion</th></tr></thead> <tbody><tr><td>793843d0-d081-4934-9782-ee92505c56cb</td> <td>D2 v3</td> <td>0.1011..</td> <td>EU West</td></tr></tbody></table> <blockquote><p><strong>Note</strong>: <strong>Price information for Azure resources</strong> is accessible through the <a href="https://docs.microsoft.com/en-us/azure/cost-management-billing/manage/usage-rate-card-overview#azure-resource-ratecard-api-preview" target="_blank" rel="noopener noreferrer"><strong>RateCard API</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.<br>
[optional] If you want to dig into some details go <a href="https://github.com/bfrankMS/myAzureCost/tree/master/SetupChallenges/GenerateAPriceSheet" target="_blank" rel="noopener noreferrer">here for a sample<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><strong>I'll provide a sample price list for you</strong>.  <a href="./challengestart/Sample_PriceSheet_EN.csv">day1\challenge-12\challengestart\Sample_PriceSheet_EN.csv</a></p> <p>Upload this to your storage account:</p> <div class="language- extra-class"><pre class="language-text"><code>[Azure Portal] -&gt; Resource Groups -&gt; &quot;rg-AzureCost&quot; -&gt; 'azconsumption...' (Your Storage Account) -&gt; Containers -&gt; 'consumption'
</code></pre></div><p><img src="/trainingdays/assets/img/RateCardCSV.94614d6d.png" alt="Pricelist on storage account"></p> <p><strong>Generate a URI with a Read only SAS token (e.g. expiry +2 years) for this file</strong> (when you have done <a href="/trainingdays/day1/challenge-06/">challenge 6</a> you know how to do this ðŸ˜‰)</p> <p><strong>Copy &amp; paste the URI (with the SAS token)</strong> into the <strong>AA variable 'myAzureCostPriceSheetURI'</strong> so that runbooks can download the pricesheet:</p> <div class="language- extra-class"><pre class="language-text"><code>[Azure Portal] -&gt; Resource Groups -&gt; &quot;rg-AzureCost&quot; -&gt; 'aaazurecost...' (Your Automation Account) -&gt; Variables
</code></pre></div><p><img src="/trainingdays/assets/img/RateCardCSVURI.5ccb22fa.png" alt="pricelist URI in AA variables"></p> <h1 id="run-a-report"><a href="#run-a-report" class="header-anchor">#</a> Run a report</h1> <p>Here you'll <strong>kick off the runbooks to test your myAzureCost implementation</strong>. You'll also might <strong>want</strong> to <strong>link</strong> the <strong>runbook</strong> to a <strong>schedule</strong> to receive a <strong>daily report</strong>.</p> <h2 id="gather-your-daily-usage-runbook"><a href="#gather-your-daily-usage-runbook" class="header-anchor">#</a> Gather your daily usage Runbook</h2> <p>Start the <strong>AA Runbook</strong> that will <strong>gather</strong> the azure <strong>usage for the previous day</strong> it'll <strong>save</strong> it as <strong>CSV</strong> (en-us) in the <strong>storage account</strong> - <strong>Leave the MYDATE parameter empty.</strong>:</p> <div class="language- extra-class"><pre class="language-text"><code>[Azure Portal] -&gt; Resource Groups -&gt; &quot;rg-AzureCost&quot; -&gt; 'aaazurecost...' (Your Automation Account) -&gt; &quot;Process Automation&quot; Runbooks -&gt; RunBk_GetUsageAggregates -&gt; Start
</code></pre></div><blockquote><p><strong>Note</strong>: The <strong>optional</strong> MYDATE parameter takes a short en-us formatted time string MM/dd/yyyy -&gt; e.g. '07/13/2020'</p></blockquote> <p>Once the <strong>runbooks is completed</strong> you should find a <strong>result report in your storage account</strong>:</p> <div class="language- extra-class"><pre class="language-text"><code>[Azure Portal] -&gt; Resource Groups -&gt; &quot;rg-AzureCost&quot; -&gt; 'azconsumption...' (Your Storage Account) -&gt; Containers -&gt; 'consumption'
</code></pre></div><p><img src="/trainingdays/assets/img/UsageAggregates.ec6f276d.png" alt="Usage aggregates of previous day in sa"></p> <h2 id="send-cost-report-email"><a href="#send-cost-report-email" class="header-anchor">#</a> Send cost report email</h2> <p>As the previous runbook has calculated the azure consumpution for a day and stored it on our storage account. We can now start the <strong>AA Runbook</strong> that will do a <strong>cost estimation</strong> and <strong>send</strong> it as email the recipient - <strong>Leave the MYDATE parameter empty.</strong>:</p> <div class="language- extra-class"><pre class="language-text"><code>[Azure Portal] -&gt; Resource Groups -&gt; &quot;rg-AzureCost&quot; -&gt; 'aaazurecost...' (Your Automation Account) -&gt; &quot;Process Automation&quot; Runbooks -&gt; RunBk_SendCostEmail -&gt; Start
</code></pre></div><blockquote><p><strong>Note</strong>: The <strong>optional</strong> MYDATE parameter takes a short en-us formatted time string MM/dd/yyyy -&gt; e.g. '07/13/2020'</p></blockquote> <p>Once the <strong>runbooks is completed</strong> you should receive an <strong>email</strong> with the <strong>costs &amp; graphs</strong> calculated and some reports attached as CSV:<br> <img src="/trainingdays/assets/img/CostEmail.40d539d7.png" alt="Cost email"></p> <p><strong>Congratulations!</strong> <strong>and wait for tomorrows email ðŸ˜ƒ</strong></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azuredevcollege/trainingdays/edit/master/day1/challenge-12/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/trainingdays/assets/js/app.d38bf813.js" defer></script><script src="/trainingdays/assets/js/2.5ff1d4d5.js" defer></script><script src="/trainingdays/assets/js/8.240e2339.js" defer></script>
  </body>
</html>
