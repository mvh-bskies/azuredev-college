<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Azure Cosmos DB # | Azure Developer College</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/trainingdays/assets/css/0.styles.bc728db4.css" as="style"><link rel="preload" href="/trainingdays/assets/js/app.d38bf813.js" as="script"><link rel="preload" href="/trainingdays/assets/js/2.5ff1d4d5.js" as="script"><link rel="preload" href="/trainingdays/assets/js/3.b5657a11.js" as="script"><link rel="prefetch" href="/trainingdays/assets/js/10.e0433817.js"><link rel="prefetch" href="/trainingdays/assets/js/11.cd8c7b17.js"><link rel="prefetch" href="/trainingdays/assets/js/12.12888c30.js"><link rel="prefetch" href="/trainingdays/assets/js/13.873bda65.js"><link rel="prefetch" href="/trainingdays/assets/js/14.1a24ee27.js"><link rel="prefetch" href="/trainingdays/assets/js/15.6fa51cf9.js"><link rel="prefetch" href="/trainingdays/assets/js/16.d5e02596.js"><link rel="prefetch" href="/trainingdays/assets/js/17.fcaa5f26.js"><link rel="prefetch" href="/trainingdays/assets/js/18.f2a21d28.js"><link rel="prefetch" href="/trainingdays/assets/js/19.a350c78d.js"><link rel="prefetch" href="/trainingdays/assets/js/20.bfd694b1.js"><link rel="prefetch" href="/trainingdays/assets/js/21.bed10b37.js"><link rel="prefetch" href="/trainingdays/assets/js/22.860246de.js"><link rel="prefetch" href="/trainingdays/assets/js/23.b225110a.js"><link rel="prefetch" href="/trainingdays/assets/js/24.13b22772.js"><link rel="prefetch" href="/trainingdays/assets/js/25.e0f5a7a3.js"><link rel="prefetch" href="/trainingdays/assets/js/26.c1146b2a.js"><link rel="prefetch" href="/trainingdays/assets/js/27.ab26807b.js"><link rel="prefetch" href="/trainingdays/assets/js/28.ab2698cc.js"><link rel="prefetch" href="/trainingdays/assets/js/29.496ec42d.js"><link rel="prefetch" href="/trainingdays/assets/js/30.fd15c623.js"><link rel="prefetch" href="/trainingdays/assets/js/31.72ed4ad1.js"><link rel="prefetch" href="/trainingdays/assets/js/32.81e15b13.js"><link rel="prefetch" href="/trainingdays/assets/js/33.f1fcf176.js"><link rel="prefetch" href="/trainingdays/assets/js/34.8432e852.js"><link rel="prefetch" href="/trainingdays/assets/js/35.61413aac.js"><link rel="prefetch" href="/trainingdays/assets/js/36.dc009a95.js"><link rel="prefetch" href="/trainingdays/assets/js/37.88c251fb.js"><link rel="prefetch" href="/trainingdays/assets/js/38.b9f64ed2.js"><link rel="prefetch" href="/trainingdays/assets/js/39.4bf7d432.js"><link rel="prefetch" href="/trainingdays/assets/js/4.316442a1.js"><link rel="prefetch" href="/trainingdays/assets/js/40.a1779f5a.js"><link rel="prefetch" href="/trainingdays/assets/js/41.b4f159db.js"><link rel="prefetch" href="/trainingdays/assets/js/42.096f1aa1.js"><link rel="prefetch" href="/trainingdays/assets/js/43.cf13395f.js"><link rel="prefetch" href="/trainingdays/assets/js/44.92be7e22.js"><link rel="prefetch" href="/trainingdays/assets/js/45.298ad7f7.js"><link rel="prefetch" href="/trainingdays/assets/js/46.4d6179b3.js"><link rel="prefetch" href="/trainingdays/assets/js/47.bc41cef1.js"><link rel="prefetch" href="/trainingdays/assets/js/48.31275a9a.js"><link rel="prefetch" href="/trainingdays/assets/js/49.a2dc55f9.js"><link rel="prefetch" href="/trainingdays/assets/js/5.815c1276.js"><link rel="prefetch" href="/trainingdays/assets/js/50.c6016f95.js"><link rel="prefetch" href="/trainingdays/assets/js/51.0bd2785b.js"><link rel="prefetch" href="/trainingdays/assets/js/52.4e12987f.js"><link rel="prefetch" href="/trainingdays/assets/js/53.fb7850b1.js"><link rel="prefetch" href="/trainingdays/assets/js/54.1f20c333.js"><link rel="prefetch" href="/trainingdays/assets/js/55.d1950d56.js"><link rel="prefetch" href="/trainingdays/assets/js/56.3a6b8119.js"><link rel="prefetch" href="/trainingdays/assets/js/57.3639003b.js"><link rel="prefetch" href="/trainingdays/assets/js/58.091b6b2a.js"><link rel="prefetch" href="/trainingdays/assets/js/59.b1b6f798.js"><link rel="prefetch" href="/trainingdays/assets/js/6.6bc81206.js"><link rel="prefetch" href="/trainingdays/assets/js/60.8312cc43.js"><link rel="prefetch" href="/trainingdays/assets/js/61.8077d507.js"><link rel="prefetch" href="/trainingdays/assets/js/62.7099a9ec.js"><link rel="prefetch" href="/trainingdays/assets/js/63.de9324f4.js"><link rel="prefetch" href="/trainingdays/assets/js/64.69b552bd.js"><link rel="prefetch" href="/trainingdays/assets/js/65.7999d6d6.js"><link rel="prefetch" href="/trainingdays/assets/js/66.bd4052c9.js"><link rel="prefetch" href="/trainingdays/assets/js/67.e79e194c.js"><link rel="prefetch" href="/trainingdays/assets/js/68.f8d8015a.js"><link rel="prefetch" href="/trainingdays/assets/js/69.e5994ee8.js"><link rel="prefetch" href="/trainingdays/assets/js/7.60b45c24.js"><link rel="prefetch" href="/trainingdays/assets/js/70.55b1b75a.js"><link rel="prefetch" href="/trainingdays/assets/js/71.eba7950f.js"><link rel="prefetch" href="/trainingdays/assets/js/72.75c0fa4d.js"><link rel="prefetch" href="/trainingdays/assets/js/73.457d78aa.js"><link rel="prefetch" href="/trainingdays/assets/js/74.a278da89.js"><link rel="prefetch" href="/trainingdays/assets/js/75.8f7da85a.js"><link rel="prefetch" href="/trainingdays/assets/js/76.306b2367.js"><link rel="prefetch" href="/trainingdays/assets/js/77.4b93f5b5.js"><link rel="prefetch" href="/trainingdays/assets/js/78.149c6cba.js"><link rel="prefetch" href="/trainingdays/assets/js/79.df492d10.js"><link rel="prefetch" href="/trainingdays/assets/js/8.240e2339.js"><link rel="prefetch" href="/trainingdays/assets/js/80.91573785.js"><link rel="prefetch" href="/trainingdays/assets/js/9.6caa67cc.js">
    <link rel="stylesheet" href="/trainingdays/assets/css/0.styles.bc728db4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/trainingdays/" class="home-link router-link-active"><!----> <span class="site-name">Azure Developer College</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/trainingdays/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/trainingdays/day1/" class="sidebar-link">Day 1 Azure Fundamentals &amp; Infrastructure</a></li><li><a href="/trainingdays/day2/" class="sidebar-link">Day 2 Azure Development</a></li><li><a href="/trainingdays/day3/" aria-current="page" class="sidebar-link">Day 3 Data and AI</a></li><li><a href="/trainingdays/day4/" class="sidebar-link">Day 4 Azure DevOps</a></li><li><a href="/trainingdays/day5/" class="sidebar-link">Day 5 Identity and Architecture</a></li><li><a href="/trainingdays/day6/" class="sidebar-link">Day 6 Containerization</a></li><li><a href="/trainingdays/day7/" class="sidebar-link">Day 7 Kubernetes</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="azure-cosmos-db"><a href="#azure-cosmos-db" class="header-anchor">#</a> Azure Cosmos DB</h1> <h2 id="here-is-what-you-will-learn"><a href="#here-is-what-you-will-learn" class="header-anchor">#</a> Here is what you will learn</h2> <ul><li>Create a Cosmos DB via the Portal</li> <li>Use an ARM Template for automated deployment</li> <li>Integrate a Cosmos DB into a Node.JS application</li> <li>Add data using Azure Data Factory</li> <li>Query and index data using Data Explorer</li> <li><em>Optional</em>: Cosmos DB Change Feed</li></ul> <h2 id="what-is-azure-cosmos-db"><a href="#what-is-azure-cosmos-db" class="header-anchor">#</a> What is Azure Cosmos DB?</h2> <p>Azure Cosmos DB:</p> <ul><li>is Microsoft's globally distributed, multi-model database service.</li> <li>with a click of a button, Cosmos DB enables you to elastically and independently scale throughput and storage across any number of Azure regions worldwide.</li> <li>you can elastically scale throughput and storage, and take advantage of fast, single-digit-millisecond data access using APIs including SQL, MongoDB, Cassandra, Azure Tables, or Gremlin.</li> <li>Cosmos DB provides comprehensive <a href="https://aka.ms/acdbsla" target="_blank" rel="noopener noreferrer">service level agreements<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (SLAs) for throughput, latency, availability and consistency guarantees, something no other database service offers.</li></ul> <p><img src="/trainingdays/assets/img/CosmosIntro.cf8df531.png" alt="Cosmos DB"></p> <h2 id="create-a-cosmos-db-via-azure-portal"><a href="#create-a-cosmos-db-via-azure-portal" class="header-anchor">#</a> Create a Cosmos DB via Azure Portal</h2> <p>First of all, create a resource group called &quot;<strong>adc-cosmos-db-rg</strong>&quot; and use location &quot;<strong>West Europe</strong>&quot; for it.</p> <p>Now add a Cosmos DB account:</p> <ul><li>choose an unique <em>Account Name</em></li> <li>API: <em>Core SQL</em></li> <li>Notebooks: <em>Off</em></li> <li>Location: <em>westeurope</em></li> <li>Capacity mode: <em>Provisioned throughput</em></li> <li>Apply Free Tier Account: <em>Do Not Apply</em></li> <li>Account Type: <em>Non-Production</em></li> <li>Geo-Redundancy: <em>Disable</em></li> <li>Multi-region Writes: <em>Enable</em></li> <li>Availability Zones: <em>Disable</em></li> <li>Hit &quot;Create&quot;</li></ul> <p><img src="/trainingdays/assets/img/CosmosCreate.51da2107.png" alt="Cosmos DB Create"></p> <p><img src="/trainingdays/assets/img/CosmosCreateDetails2.07167553.png" alt="Cosmos DB Create Details"></p> <h2 id="add-data-to-cosmos-db"><a href="#add-data-to-cosmos-db" class="header-anchor">#</a> Add Data to Cosmos DB</h2> <p>We need, of course, data to work with our Cosmos DB, so let's add sample documents to it.</p> <p>Open the CosmosDB in the Portal and select <em>Data Explorer</em> from the left navigation menu on your Azure Cosmos DB account page, and then select <strong>New Container</strong>.</p> <p>In the <em>Add container pane</em>, enter the settings for the new container:</p> <ul><li>Database ID (<em>Create new</em>): <em>name</em></li> <li>Throughput (<em>Manual</em>): <em>400</em></li> <li>Container ID: <em>Items</em></li> <li>Partition key: <em>/id</em></li></ul> <p>Hit &quot;Ok&quot; and wait until it has been created.</p> <p>In Data Explorer, expand the (<strong>name</strong>) database, and expand the <strong>Items</strong> container. Next, select <strong>Items</strong> entry, and then select <strong>New Item</strong>.</p> <p>Add the following structure to the document on the right side of the Documents pane and hit <strong>Save</strong>:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;category&quot;</span><span class="token operator">:</span> <span class="token string">&quot;personal&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;groceries&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Pick up apples and strawberries.&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;isComplete&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;todoId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;abc-123&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;date&quot;</span><span class="token operator">:</span> <span class="token number">2020</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Select <strong>New Document</strong> again, and create and save another document with a unique id, and any other properties and values you want. Your documents can have any structure, because Azure Cosmos DB doesn't impose any schema on your data.</p> <p>At the top of the <strong>Items</strong> tab in Data Explorer, review the default query <code>SELECT * FROM c</code>. This query retrieves and displays all documents in the collection.</p> <p>To change the query, select <strong>Edit Filter</strong>, replace the default query with <code>SELECT * FROM c WHERE (c.id = &quot;1&quot; AND c.todoId = &quot;abc-123&quot;)</code>, and then select <strong>Apply Filter</strong>.</p> <p><img src="/trainingdays/assets/img/CosmosItemPartition.cdb11743.png" alt="Cosmos Data: Create Item"></p> <h2 id="understand-partition-keys"><a href="#understand-partition-keys" class="header-anchor">#</a> Understand Partition Keys</h2> <h3 id="why-do-we-need-partitioning"><a href="#why-do-we-need-partitioning" class="header-anchor">#</a> Why do we need partitioning?</h3> <ul><li>Azure Cosmos containers have a minimum throughput of 400 request units per second (RU/s).</li> <li>When throughput is provisioned on a database level, the minimum RUs per container is <em>100</em>.</li> <li>Requests to the same partition key can't exceed the throughput that's allocated to a partition.</li> <li>If requests exceed the allocated throughput, requests are rate-limited (when you talk to Azure CosmosDB directly, you will receive a <em>429 - Too Many Requests</em> status code).</li> <li>It is important to pick a partition key that doesn't result in &quot;hot spots&quot; (a partition that is constantly requested) within your application</li></ul> <h3 id="how-to-choose-a-partiton-key"><a href="#how-to-choose-a-partiton-key" class="header-anchor">#</a> How to choose a partiton key?</h3> <p>Choose a partition key...</p> <ul><li>that has a wide range of values and access patterns that are evenly spread across logical partitions.</li> <li>that spreads the workload evenly across all partitions and evenly over time.</li> <li>that might include properties that appear frequently as a filter in your queries. Queries can be efficiently routed by including the partition key in the filter predicate.</li></ul> <blockquote><p><strong>IMPORTANT</strong>: A single logical partition has an upper limit of 10 GB of storage.</p></blockquote> <p>You can form a partition key by concatenating multiple property values into a single artificial partition key property. These keys are referred to as <em>synthetic keys</em>.</p> <ul><li><p>For example, consider the following example document:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;todoId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;abc-123&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;date&quot;</span><span class="token operator">:</span> <span class="token number">2020</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>For the previous document, one option is to set /todoId or /date as the partition key. Use this option, if you want to partition your container based on either device ID or date. Another option is to concatenate these two values into a synthetic <strong>partitionKey</strong> property that's used as the partition key.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;todoId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;abc-123&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;date&quot;</span><span class="token operator">:</span> <span class="token number">2020</span><span class="token punctuation">,</span>
    <span class="token property">&quot;partitionKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;abc-123-2020&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="use-arm-template-for-automated-deployment"><a href="#use-arm-template-for-automated-deployment" class="header-anchor">#</a> Use ARM Template for automated deployment</h2> <p>The following Azure Resource Manager template creates an Azure Cosmos account with:</p> <ul><li>Two containers that share 400 Requested Units per second (RU/s) throughput at the database level.</li> <li>One container with dedicated 400 RU/s throughput.</li></ul> <p>We will be using Azure CLI to deploy the ARM template. Navigate to the <strong>template.json</strong> in this folder <em>(day3/apps/arm/template.json)</em> and <br>
and look at the <strong>&quot;defaultValue&quot;</strong> parameter where the value will be the new <strong>Cosmos DB account name</strong> including the name <em>cosmosdb</em> and a <em>unique ID</em>.</p> <div class="language-template.json extra-class"><pre class="language-text"><code>&quot;parameters&quot;: {
        &quot;databaseAccount&quot;: {
            &quot;defaultValue&quot;: &quot;[concat('cosmosdb-', uniqueString(resourceGroup().id))]&quot;,
            &quot;type&quot;: &quot;String&quot;
        }
    },
</code></pre></div><p>Now let's use the commands below (if you chose a different name for your resource group, please adjust the command) <br>
For the second command you will copy <strong>&lt;YOUR_NEW_ACCOUNT_NAME&gt;</strong> from the portal once the Cosmos DB is successfully created:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ az deployment group create --resource-group adc-cosmos-db-rg <span class="token punctuation">\</span>
--template-uri https://raw.githubusercontent.com/azuredevcollege/trainingdays/master/day3/apps/arm/template.json

$ az cosmosdb show --resource-group adc-cosmos-db-rg  --name <span class="token operator">&lt;</span>YOUR_NEW_ACCOUNT_NAME<span class="token operator">&gt;</span> --output tsv
</code></pre></div><p><img src="/trainingdays/assets/img/ARMDeployCosmos.9a12bf6a.png" alt="Bash Cloud Shell command"></p> <p><img src="/trainingdays/assets/img/ARMDeployCosmosResult.da1f18ba.png" alt="Result of deployed Cosmos DB via ARM Template"></p> <h2 id="integrate-cosmos-db-into-a-node-js-app"><a href="#integrate-cosmos-db-into-a-node-js-app" class="header-anchor">#</a> Integrate Cosmos DB into a Node.JS App</h2> <p>We now want to show you, how to integrate Azure Cosmos DB with a NodeJS application. You can find SDKs for a lot of programming languages out there - as a sample, we will be using the NodeJS SDK.</p> <p>There is already a predefined sample you can clone to your machine. So, please open a command line window and in a <em>new folder</em>, run the following command to clone the sample:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">git</span> clone https://github.com/CodeUnicornMartha/azure-cosmos-db-sql-api-nodejs-getting-started.git
</code></pre></div><p>Open the folder the repo has been cloned to in Visual Studio Code.</p> <p><img src="/trainingdays/assets/img/CosmosApp.193eda5c.png" alt="Cosmos DB integrated in an App (Visual Studio Code View)"></p> <p>Before you run the sample, here are some hints what's happening in the app:</p> <ul><li><p>In <strong>app.js</strong>:</p> <ul><li>The CosmosClient object is initialized.</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    const client = new CosmosClient({ endpoint, key });
</code></pre></div><ul><li>A new Azure Cosmos database is created.</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    const { database } = await client.databases.createIfNotExists({ id: databaseId });
</code></pre></div><ul><li>A new container (collection) is created within the database.</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    const { container } = await client.database(databaseId).containers.createIfNotExists({ id: containerId });
</code></pre></div><ul><li>An item (document) is created</li></ul> <div class="language- extra-class"><pre class="language-text"><code>    const { item } = await client.database(databaseId).container(containerId).items.create(itemBody);
</code></pre></div></li></ul> <p>These are the basic commands to interact with Azure Cosmos DB.</p> <p><img src="/trainingdays/assets/img/CosmosAppView2.d909b8cd.png" alt="Cosmos DB Client"></p> <p>A little bit further down, you can see how to query against CosmosDB. (The query returns all the children of a family). You first create a query specification which in turn is handed over to the Cosmos client, that executes the query against the database.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>    <span class="token keyword">const</span> querySpec <span class="token operator">=</span> <span class="token punctuation">{</span>
        query<span class="token operator">:</span> <span class="token string">'SELECT VALUE r.children FROM root r WHERE r.lastName = @lastName'</span><span class="token punctuation">,</span>
        parameters<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                name<span class="token operator">:</span> <span class="token string">'@lastName'</span><span class="token punctuation">,</span>
                value<span class="token operator">:</span> <span class="token string">'Andersen'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> resources<span class="token operator">:</span> results <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> client
        <span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span>databaseId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">container</span><span class="token punctuation">(</span>containerId<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>querySpec<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fetchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> queryResult <span class="token keyword">of</span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> resultString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>queryResult<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\tQuery returned </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resultString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><img src="/trainingdays/assets/img/CosmosDBQuery.f6c8bfb5.png" alt="Cosmos DB Query"></p> <h2 id="run-the-sample-application"><a href="#run-the-sample-application" class="header-anchor">#</a> Run the sample application</h2> <p>In order to run the sample application, we need to adjust some settings (in file <em>config.js</em>) that the app knows where to &quot;find&quot; our database.</p> <ul><li><p>In the Azure portal, open the Azure Cosmos account you just created, in the left navigation click <strong>Keys</strong> (under <strong>Settings</strong>), and then click <strong>Read-write Keys</strong>.
Copy the <strong>URI</strong> as you will need it now in the NodeJS code.</p></li> <li><p>Open the <strong>config.js</strong> file.</p></li> <li><p>use the URL as the value for <em>config.endpoint</em> variable.</p></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>config<span class="token punctuation">.</span>endpoint <span class="token operator">=</span> <span class="token string">&quot;https://&lt;URI&gt;.documents.azure.com:443&quot;</span>
</code></pre></div><ul><li>Then copy your <strong>PRIMARY KEY</strong> value from the portal and make it the value of <em>config.key</em>.</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>config<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">&quot;&lt;PRIMARY KEY&gt;&quot;</span>
</code></pre></div><p><img src="/trainingdays/assets/img/CosmosConnectionString.138da202.png" alt="Cosmos DB Connection String"></p> <p>You've now updated your app with all the info it needs to communicate with Azure Cosmos DB.</p> <p>Now you are all set to run the sample. In the terminal, we first need to install all the dependencies of the Node app. So please run:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">npm</span> <span class="token function">install</span>
</code></pre></div><p>After it has finished downloading the dependencies, run:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">npm</span> start
</code></pre></div><h2 id="add-data-using-azure-data-factory"><a href="#add-data-using-azure-data-factory" class="header-anchor">#</a> Add Data using Azure Data Factory</h2> <p>Now we want to add a little bit more data to our Cosmos DB. So please follow the instructions below as we add data via <strong>Azure Data Factory</strong>. Azure Data Factory is a managed cloud service that's built to handle complex hybrid extract-transform-load (ETL), extract-load-transform (ELT), and data integration projects. It solves the problem of consolidating and loading data from various sources - either in the cloud or on-premises. If you want to know more about that service, please go to <a href="https://docs.microsoft.com/en-us/azure/data-factory/introduction" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/azure/data-factory/introduction<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>First and foremost, we will be creating an new database plus a new container. Go to your Cosmos DB account, you created previously and click on <strong>Add Container</strong> (database will be created <em>on-the-fly</em>).</p> <ol><li><p>In the <strong>Database id</strong> field, select the <strong>Create new</strong> option and enter the value &quot;<strong>ImportDatabase</strong>&quot;.</p></li> <li><p>Uncheck the <strong>Provision database throughput</strong> option (RUs will be provisioned on the collection level).</p></li> <li><p>In the <strong>Container Id</strong> field, enter the value &quot;<strong>FoodCollection</strong>&quot;.</p></li> <li><p>In the <strong>Partition key</strong> field, enter the value <code>/foodGroup</code>.</p></li> <li><p>After ticking the box <strong>Provision dedicated throughput for this container</strong> enter the value <code>11000</code> in the <strong>Throughput</strong> field.</p></li> <li><p>Click the <strong>OK</strong> button.
<img src="/trainingdays/assets/img/CosmosFoodCollection.7d7394c9.png" alt="Cosmos DB: Food Collection"></p></li> <li><p>Wait for the creation of the new <strong>database</strong> and <strong>container</strong> to finish before moving on with this lab.</p></li></ol> <h2 id="import-lab-data-into-container"><a href="#import-lab-data-into-container" class="header-anchor">#</a> Import Lab Data Into Container</h2> <p>You will use <strong>Azure Data Factory (ADF)</strong> to import the JSON array stored in the <strong>nutrition.json</strong> file from Azure Blob Storage.</p> <blockquote><p>To learn more about copying data to Cosmos DB with ADF, please read <a href="https://docs.microsoft.com/en-us/azure/data-factory/connector-azure-cosmos-db" target="_blank" rel="noopener noreferrer">ADF's documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></blockquote> <ol><li><p>On the left side of the portal, click the <strong>Resource groups</strong> link.</p></li> <li><p>In the <strong>Resource groups</strong> blade, locate and select the resource group of your CosmosDB account.</p></li> <li><p>Click <strong>Add</strong> to add a new resource. Search for <strong>Data Factory</strong> and select it.
<img src="/trainingdays/assets/img/DataFactoryCosmos.57233dee.png" alt="Azure Data Factory"></p></li> <li><p>Create a new <strong>Data Factory</strong>. You should name this data factory &quot;<strong>ImportNutritionDataAppdevCollege(yourname)</strong>&quot; (optionally you can append a unique number) and select the relevant Azure subscription. You should ensure that Version &quot;<strong>V2</strong>&quot; is selected. Select &quot;<strong>West Europe</strong>&quot; as the region.</p></li></ol> <p><img src="/trainingdays/assets/img/DataFactoryDetails.a31747f6.png" alt="Data Factory Details"></p> <p>Do select <strong>Configure Git later</strong> (found on the second screen). Click through all the screens and hit <strong>create</strong>.</p> <p><img src="/trainingdays/assets/img/ConfigureGITLater.041aeeb0.png" alt="Data Factory Configure GIT later"></p> <blockquote><p>In case you get a validation error please use the Azure Cloud Shell and enter the following command</p> <div class="language-Shell extra-class"><pre class="language-shell"><code>$ az datafactory factory create -g adc-cosmos-db-rg -n ImportNutritionDataAppdevCollege<span class="token punctuation">(</span>yourname<span class="token punctuation">)</span> -l westeurope
</code></pre></div></blockquote> <p><img src="/trainingdays/assets/img/datafactorycloudshell.70152489.png" alt="Data Factory Cloud Shell"></p> <ol><li>After creation, open your newly created Data Factory. Select <strong>Author &amp; Monitor</strong> and you will launch ADF. You should see a screen similar to the screenshot below.
(We will be using ADF for a one-time copy of data from a source JSON file on Azure Blob Storage to a database in Cosmos DB’s SQL API. ADF can also be used for more frequent data transfers from Cosmos DB to other data stores.)</li></ol> <p><img src="/trainingdays/assets/img/CopyDataFactory.91d4928c.png" alt="Data Factory Copy Data"></p> <ol><li><p>Select &quot;<strong>Copy Data</strong>&quot;. Edit basic properties for this data copy. You should name the task &quot;<strong>ImportNutrition</strong>&quot; and select to &quot;<strong>Run once now</strong>&quot;. Click <strong>Next</strong>.</p></li> <li><p><strong>Create a new connection</strong> and select <strong>Azure Blob Storage</strong>. We will import data from a json file on Azure Blob Storage. In addition to Blob Storage, you can use ADF to migrate from a wide variety of sources. We will not cover migration from these sources in this tutorial.</p></li> <li><p>Name the source &quot;<strong>NutritionJson</strong>&quot; and select <strong>SAS URI</strong> as the Authentication method. Please use the following SAS URI for read-only access to this Blob Storage container:
<code>https://cosmosdblabsv3.blob.core.windows.net/?sv=2018-03-28&amp;ss=bfqt&amp;srt=sco&amp;sp=rlp&amp;se=2022-01-01T04:55:28Z&amp;st=2019-08-05T20:02:28Z&amp;spr=https&amp;sig=%2FVbismlTQ7INplqo6WfU8o266le72o2bFdZt1Y51PZo%3D</code></p></li></ol> <p><img src="/trainingdays/assets/img/DataSourceFactory.bb20ec28.png" alt="Data Source Factory"></p> <ol><li><p>Click <strong>Create</strong> and in the wizard view <strong>Next</strong> then <strong>Browse</strong> to select the <strong>nutritiondata</strong> folder. Then select &quot;<strong>NutritionData.json</strong>&quot;.
<img src="/trainingdays/assets/img/FactoryJSON.e9e772a9.png" alt="Nutrition JSON"></p></li> <li><p>Uncheck <strong>Copy file recursively</strong> and <strong>Binary Copy</strong>. Also ensure that other fields are empty. Select <strong>Next</strong>.</p></li> <li><p>Select the file format as <strong>JSON format</strong>. Then select <strong>Next</strong>.</p></li></ol> <p><img src="/trainingdays/assets/img/DestinationJSON.e846a316.png" alt="JSON Format">
You have now successfully connected the Blob Storage container with the <em>nutrition.json</em> file as the source.</p> <ol><li><p>For the <strong>Destination data store</strong> add the Cosmos DB target data store by selecting <strong>Create new connection</strong> and selecting <strong>Azure Cosmos DB (SQL API)</strong>.</p></li> <li><p>Name the linked service &quot;<strong>targetcosmosdb</strong>&quot; and select your Azure subscription and Cosmos DB account. You should also select the Cosmos DB <strong>ImportDatabase</strong> that you created earlier. Click <strong>Create</strong>.</p></li></ol> <p><img src="/trainingdays/assets/img/TargetCosmosDB.a53b041a.png" alt="Target Cosmos DB"></p> <ol start="11"><li>Select your newly created <strong>targetcosmosdb</strong> connection as the Destination date store.</li></ol> <p><img src="/trainingdays/assets/img/TargetCosmosDB2.96a3dd84.png" alt="Target Cosmos DB"></p> <ol><li><p>Select your <strong>FoodCollection</strong> container from the drop-down menu. You will map your Blob storage file to the correct Cosmos DB container. Click <strong>Next</strong> to continue.</p></li> <li><p>There is no need to change any settings, so click <strong>Next</strong>.</p></li> <li><p>You are now on the Summary Screen. It should now look similar to this screenshot. If everything is setup correctly, click <strong>Next</strong> to begin deployment. After deployment is complete, select <strong>Monitor</strong>.
<img src="/trainingdays/assets/img/DataFactorySuccess.6a926238.png" alt="Data Factory Success"></p></li> <li><p>After a few minutes, refresh the page and the status for the ImportNutrition pipeline should be listed as <strong>Succeeded</strong>.</p></li> <li><p>Once the import process has completed, close the ADF. You will now proceed to validate your imported data.</p></li></ol> <h3 id="validate-imported-data"><a href="#validate-imported-data" class="header-anchor">#</a> Validate Imported Data</h3> <p><em>The Azure Cosmos DB Data Explorer allows you to view documents and run queries directly within the Azure Portal. In this exercise, you will use the Data Explorer to view the data stored in our container.</em></p> <p><em>You will validate that the data was successfully imported into your container using the <strong>Items</strong> view in the <strong>Data Explorer</strong>.</em></p> <p>So, open the Cosmos DB Account you just imported the nutrition data to.</p> <ol><li><p>In the <strong>Azure Cosmos DB</strong> blade, locate and click the <strong>Data Explorer</strong> link on the left side of the blade.</p></li> <li><p>In the <strong>Data Explorer</strong> section, expand the <strong>ImportDatabase</strong> database node and then expand the <strong>FoodCollection</strong> container node.</p></li> <li><p>Within the <strong>FoodCollection</strong> node, click the <strong>Items</strong> link to view a subset of the various documents in the container. Select a few of the documents and observe the properties and structure of the documents.</p></li></ol> <p><img src="/trainingdays/assets/img/FoodCollectionDatafactory.d094e55b.png" alt="Data Explorer"></p> <h2 id="querying-and-indexing-in-azure-cosmos-db"><a href="#querying-and-indexing-in-azure-cosmos-db" class="header-anchor">#</a> Querying and Indexing in Azure Cosmos DB</h2> <p>Azure Cosmos DB SQL API accounts provide support for querying items using the Structured Query Language (SQL), one of the most familiar and popular query languages, as a JSON query language. In this lab, you will explore how to use these rich query capabilities directly through the Azure Portal. No separate tools or client side code are required.</p> <h3 id="query-overview"><a href="#query-overview" class="header-anchor">#</a> Query Overview</h3> <p>Querying JSON with SQL allows Azure Cosmos DB to combine the advantages of a legacy relational databases with a NoSQL database. You can use many rich query capabilities such as subqueries or aggregation functions but still retain the many advantages of modeling data in a NoSQL database.</p> <p>Azure Cosmos DB supports strict JSON items only. The type system and expressions are restricted to deal only with JSON types. For more information, see the <a href="https://www.json.org/" target="_blank" rel="noopener noreferrer">JSON specification<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="running-your-first-query"><a href="#running-your-first-query" class="header-anchor">#</a> Running your first query</h3> <p>You will begin by running basic queries with <code>SELECT</code>, <code>WHERE</code>, and <code>FROM</code> clauses. Open the <strong>Data Explorer</strong>.</p> <ol><li>In the <strong>Azure Cosmos DB</strong> blade, locate and click the <strong>Data Explorer</strong> link on the left side of the blade.</li> <li>In the <strong>Data Explorer</strong> section, expand the <strong>ImportDatabase</strong> database node and then expand the <strong>FoodCollection</strong> container node.</li> <li>Within the <strong>FoodCollection</strong> node, click the <strong>Items</strong> link.</li> <li>View the items within the container. Observe how these documents have many properties, including arrays.</li> <li>Click <strong>New SQL Query</strong>. Paste the following SQL query and select <strong>Execute Query</strong>.</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> food
<span class="token keyword">WHERE</span> food<span class="token punctuation">.</span>foodGroup <span class="token operator">=</span> <span class="token string">&quot;Snacks&quot;</span> <span class="token operator">and</span> food<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">&quot;19015&quot;</span>
</code></pre></div><ol start="7"><li>Explore the structure of this item as it is representative of the items within the <strong>FoodCollection</strong> container that we will be working with for the remainder of this section.</li></ol> <p><img src="/trainingdays/assets/img/FoodQuery.98f157ae.png" alt="Food Query"></p> <h3 id="dot-and-quoted-property-projection-accessors"><a href="#dot-and-quoted-property-projection-accessors" class="header-anchor">#</a> Dot and quoted property projection accessors</h3> <p>You can choose which properties of the document to project into the result using the dot notation. If you wanted to return only the item's id you could run the query below:
by clicking the <strong>New SQL Query</strong>. Paste the following SQL query and selecting <strong>Execute Query</strong>.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> food<span class="token punctuation">.</span>id
<span class="token keyword">FROM</span> food
<span class="token keyword">WHERE</span> food<span class="token punctuation">.</span>foodGroup <span class="token operator">=</span> <span class="token string">&quot;Snacks&quot;</span> <span class="token operator">and</span> food<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">&quot;19015&quot;</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodQuery2.f8bb0be1.png" alt="Food Query"></p> <p>Though less common, you can also access properties using the quoted property operator [&quot;&quot;]. For example, <code>SELECT food.id</code> and <code>SELECT food[&quot;id&quot;]</code> are equivalent. This syntax is useful to escape a property that contains spaces, special characters, or has the same name as a SQL keyword or reserved word.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> food<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span>
<span class="token keyword">FROM</span> food
<span class="token keyword">WHERE</span> food<span class="token punctuation">[</span><span class="token string">&quot;foodGroup&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Snacks&quot;</span> <span class="token operator">and</span> food<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;19015&quot;</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodQuery3.4b1a030c.png" alt="Food Query"></p> <h3 id="where-clauses"><a href="#where-clauses" class="header-anchor">#</a> WHERE clauses</h3> <p>Let’s explore <strong>WHERE</strong> clauses. You can add complex scalar expressions including arithmetic, comparison and logical operators in the <strong>WHERE</strong> clause.</p> <ol><li>Run the below query by clicking the <strong>New SQL Query</strong>. Paste the following SQL query and then click <strong>Execute Query</strong>.</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> food<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>tags<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>foodGroup<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>version
<span class="token keyword">FROM</span> food
<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>food<span class="token punctuation">.</span>manufacturerName <span class="token operator">=</span> <span class="token string">&quot;The Coca-Cola Company&quot;</span> <span class="token operator">AND</span> food<span class="token punctuation">.</span>version <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodWhere.26ef7b83.png" alt="Where Clause"></p> <p>This query will return the id, description, servings, tags, foodGroup, manufacturerName and version for items with &quot;The Coca-Cola Company&quot; for manufacturerName and a version greater than 0.</p> <p>Your first result document should be:</p> <div class="language-json extra-class"><pre class="language-json"><code> <span class="token punctuation">{</span>
        <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;14461&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Beverages, COCA-COLA, POWERADE, lemon-lime flavored, ready-to-drink&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;beverages&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;coca-cola&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;powerade&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lemon-lime flavored&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ready-to-drink&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;foodGroup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Beverages&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>You should note that where the query returned the results of tags node it projected the entire contents of the property which in this case is an array.</p> <h3 id="advanced-projection"><a href="#advanced-projection" class="header-anchor">#</a> Advanced projection</h3> <p>Azure Cosmos DB supports several forms of transformation on the resultant JSON. One of the simplest is to alias your JSON elements using the AS aliasing keyword as you project your results.</p> <p>By running the query below you will see that the element names are transformed. In addition, the projection is accessing only the first element in the servings array for all items specified by the <strong>WHERE</strong> clause.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> food<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>foodGroup<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>servings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>description <span class="token keyword">AS</span> servingDescription<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>servings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weightInGrams <span class="token keyword">AS</span> servingWeight
<span class="token keyword">FROM</span> food
<span class="token keyword">WHERE</span> food<span class="token punctuation">.</span>foodGroup <span class="token operator">=</span> <span class="token string">&quot;Fruits and Fruit Juices&quot;</span>
<span class="token operator">AND</span> food<span class="token punctuation">.</span>servings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>description <span class="token operator">=</span> <span class="token string">&quot;cup&quot;</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodWhere2.e78034cd.png" alt="Where Clause"></p> <h3 id="order-by-clause"><a href="#order-by-clause" class="header-anchor">#</a> ORDER BY clause</h3> <p>Azure Cosmos DB supports adding an <strong>ORDER BY</strong> clause to sort results based on one or more properties</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> food<span class="token punctuation">.</span>description<span class="token punctuation">,</span> 
food<span class="token punctuation">.</span>foodGroup<span class="token punctuation">,</span> 
food<span class="token punctuation">.</span>servings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>description <span class="token keyword">AS</span> servingDescription<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>servings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weightInGrams <span class="token keyword">AS</span> servingWeight
<span class="token keyword">FROM</span> food
<span class="token keyword">WHERE</span> food<span class="token punctuation">.</span>foodGroup <span class="token operator">=</span> <span class="token string">&quot;Fruits and Fruit Juices&quot;</span> <span class="token operator">AND</span> food<span class="token punctuation">.</span>servings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>description <span class="token operator">=</span> <span class="token string">&quot;cup&quot;</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> food<span class="token punctuation">.</span>servings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weightInGrams <span class="token keyword">DESC</span>
</code></pre></div><p><img src="/trainingdays/assets/img/OrderBy.b28b84e1.png" alt="Oder By Query"></p> <p>You can learn more about configuring the required indexes for an Order By clause in the later Indexing Lab or by reading <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/sql-query-order-by" target="_blank" rel="noopener noreferrer">the docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="limiting-query-result-size"><a href="#limiting-query-result-size" class="header-anchor">#</a> Limiting query result size</h3> <p>Azure Cosmos DB supports the <strong>TOP</strong> keyword. <strong>TOP</strong> can be used to limit the number of returning values from a query.</p> <p>Run the query below to see the top 20 results.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">TOP</span> <span class="token number">20</span> food<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>tags<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>foodGroup
<span class="token keyword">FROM</span> food
<span class="token keyword">WHERE</span> food<span class="token punctuation">.</span>foodGroup <span class="token operator">=</span> <span class="token string">&quot;Snacks&quot;</span>
</code></pre></div><p>The <strong>OFFSET LIMIT</strong> clause is an optional clause to skip then take some number of values from the query. The OFFSET count and the LIMIT count are required in the <strong>OFFSET LIMIT</strong> clause.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> food<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>tags<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>foodGroup
<span class="token keyword">FROM</span> food
<span class="token keyword">WHERE</span> food<span class="token punctuation">.</span>foodGroup <span class="token operator">=</span> <span class="token string">&quot;Snacks&quot;</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> food<span class="token punctuation">.</span>id
<span class="token keyword">OFFSET</span> <span class="token number">10</span> <span class="token keyword">LIMIT</span> <span class="token number">10</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodQuery4.2d842021.png" alt="Food Query"></p> <blockquote><p>When OFFSET LIMIT is used in conjunction with an ORDER BY clause, the result set is produced by doing skip and take on the ordered values. If no ORDER BY clause is used, it will result in a deterministic order of values.</p></blockquote> <p>With the features shown here, it's quite simple to implement <strong>Paging and Sorting</strong> in your applications.</p> <h3 id="more-advanced-filtering"><a href="#more-advanced-filtering" class="header-anchor">#</a> More advanced filtering</h3> <p>Let’s add the <strong>IN</strong> and <strong>BETWEEN</strong> keywords into our queries. <strong>IN</strong> can be used to check whether a specified value matches any element in a given list and <strong>BETWEEN</strong> can be used to run queries against a range of values. Run some sample queries below:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> food<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
       food<span class="token punctuation">.</span>description<span class="token punctuation">,</span>
       food<span class="token punctuation">.</span>tags<span class="token punctuation">,</span>
       food<span class="token punctuation">.</span>foodGroup<span class="token punctuation">,</span>
       food<span class="token punctuation">.</span>version
<span class="token keyword">FROM</span> food
<span class="token keyword">WHERE</span> food<span class="token punctuation">.</span>foodGroup <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">&quot;Poultry Products&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sausages and Luncheon Meats&quot;</span><span class="token punctuation">)</span>
    <span class="token operator">AND</span> <span class="token punctuation">(</span>food<span class="token punctuation">.</span>id <span class="token operator">BETWEEN</span> <span class="token string">&quot;05740&quot;</span> <span class="token operator">AND</span> <span class="token string">&quot;07050&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodQuery5.9ac1d018.png" alt="Food Query"></p> <h3 id="more-advanced-projection"><a href="#more-advanced-projection" class="header-anchor">#</a> More advanced projection</h3> <p>Azure Cosmos DB supports JSON projection within its queries. Let’s project a new JSON Object with modified property names. Run the query below to see the results.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> { 
<span class="token string">&quot;Company&quot;</span>: food<span class="token punctuation">.</span>manufacturerName<span class="token punctuation">,</span>
<span class="token string">&quot;Brand&quot;</span>: food<span class="token punctuation">.</span>commonName<span class="token punctuation">,</span>
<span class="token string">&quot;Serving Description&quot;</span>: food<span class="token punctuation">.</span>servings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>description<span class="token punctuation">,</span>
<span class="token string">&quot;Serving in Grams&quot;</span>: food<span class="token punctuation">.</span>servings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>weightInGrams<span class="token punctuation">,</span>
<span class="token string">&quot;Food Group&quot;</span>: food<span class="token punctuation">.</span>foodGroup 
} <span class="token keyword">AS</span> Food
<span class="token keyword">FROM</span> food
<span class="token keyword">WHERE</span> food<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">&quot;21421&quot;</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodQuery6.b75f5ef2.png" alt="Food Query"></p> <h3 id="join-within-your-documents"><a href="#join-within-your-documents" class="header-anchor">#</a> JOIN within your documents</h3> <p>Azure Cosmos DB’s <strong>JOIN</strong> supports intra-document and self-joins. Azure Cosmos DB does not support <strong>JOIN</strong>s across documents or containers.</p> <p>In an earlier query example we returned a result with attributes of just the first serving of the food.servings array. By using the join syntax below, we can now return an item in the result for every item within the serving array while still being able to project the attributes from elsewhere into the item.</p> <p>Run the query below to iterate on the food document’s servings.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
food<span class="token punctuation">.</span>id <span class="token keyword">as</span> FoodID<span class="token punctuation">,</span>
serving<span class="token punctuation">.</span>description <span class="token keyword">as</span> ServingDescription
<span class="token keyword">FROM</span> food
<span class="token keyword">JOIN</span> serving <span class="token operator">IN</span> food<span class="token punctuation">.</span>servings
<span class="token keyword">WHERE</span> food<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">&quot;03226&quot;</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodQuery7.3f7f8ad9.png" alt="Food Query"></p> <p>JOINs are useful if you need to filter on properties within an array. Run the below example that has filter after the intra-document JOIN.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">VALUE</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> c
<span class="token keyword">JOIN</span> t <span class="token operator">IN</span> c<span class="token punctuation">.</span>tags
<span class="token keyword">JOIN</span> s <span class="token operator">IN</span> c<span class="token punctuation">.</span>servings
<span class="token keyword">WHERE</span> t<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'infant formula'</span> <span class="token operator">AND</span> s<span class="token punctuation">.</span>amount <span class="token operator">&gt;</span> <span class="token number">1</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodQuery8.b0598e24.png" alt="Food Query"></p> <h3 id="system-functions"><a href="#system-functions" class="header-anchor">#</a> System functions</h3> <p>Azure Cosmos DB supports a number of built-in functions for common operations. They cover mathematical functions like <strong>ABS</strong>, <strong>FLOOR</strong> and <strong>ROUND</strong> and type checking functions like <strong>IS_ARRAY</strong>, <strong>IS_BOOL</strong> and <strong>IS_DEFINED</strong>. <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/sql-query-system-functions" target="_blank" rel="noopener noreferrer">Learn more about supported system functions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Run the query below to see example use of some system functions:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> food<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>commonName<span class="token punctuation">,</span>
food<span class="token punctuation">.</span>foodGroup<span class="token punctuation">,</span>
<span class="token function">ROUND</span><span class="token punctuation">(</span>nutrient<span class="token punctuation">.</span>nutritionValue<span class="token punctuation">)</span> <span class="token keyword">AS</span> amount<span class="token punctuation">,</span>
nutrient<span class="token punctuation">.</span>units
<span class="token keyword">FROM</span> food <span class="token keyword">JOIN</span> nutrient <span class="token operator">IN</span> food<span class="token punctuation">.</span>nutrients
<span class="token keyword">WHERE</span> IS_DEFINED<span class="token punctuation">(</span>food<span class="token punctuation">.</span>commonName<span class="token punctuation">)</span>
<span class="token operator">AND</span> nutrient<span class="token punctuation">.</span>description <span class="token operator">=</span> <span class="token string">&quot;Water&quot;</span>
<span class="token operator">AND</span> food<span class="token punctuation">.</span>foodGroup <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">&quot;Sausages and Luncheon Meats&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Legumes and Legume Products&quot;</span><span class="token punctuation">)</span>
<span class="token operator">AND</span> food<span class="token punctuation">.</span>id <span class="token operator">&gt;</span> <span class="token string">&quot;42178&quot;</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodQuery9.5ceab989.png" alt="Food Query"></p> <h3 id="correlated-subqueries"><a href="#correlated-subqueries" class="header-anchor">#</a> Correlated subqueries</h3> <p>In many scenarios, a subquery may be effective. A correlated subquery is a query that references values from an outer query.</p> <p>We will walk through some of the most useful examples here. You can <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/sql-query-subquery" target="_blank" rel="noopener noreferrer">learn more about subqueries<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>There are two types of subqueries:* Multi-value* subqueries and scalar subqueries.* Multi-value* subqueries return a set of documents and are always used within the FROM clause. A scalar subquery expression is a subquery that evaluates to a single value.</p> <h4 id="multi-value-subqueries"><a href="#multi-value-subqueries" class="header-anchor">#</a> Multi-value subqueries</h4> <p>You can optimize JOIN expressions with a subquery.</p> <p>Consider the following query which performs a self-join and then applies a filter on name, nutritionValue, and amount. We can use a subquery to filter out the joined array items before joining with the next expression.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">VALUE</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> c
<span class="token keyword">JOIN</span> t <span class="token operator">IN</span> c<span class="token punctuation">.</span>tags
<span class="token keyword">JOIN</span> n <span class="token operator">IN</span> c<span class="token punctuation">.</span>nutrients
<span class="token keyword">JOIN</span> s <span class="token operator">IN</span> c<span class="token punctuation">.</span>servings
<span class="token keyword">WHERE</span> t<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'infant formula'</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>nutritionValue <span class="token operator">&gt;</span> <span class="token number">0</span> 
<span class="token operator">AND</span> n<span class="token punctuation">.</span>nutritionValue <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">AND</span> s<span class="token punctuation">.</span>amount <span class="token operator">&gt;</span> <span class="token number">1</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodQuery10.27c92b2f.png" alt="Food Query"></p> <p>Let's look at the Request Unit Statistics:</p> <p><img src="/trainingdays/assets/img/QueryStatshigh.45e1b49b.png" alt="Query Statistics"></p> <p>We could rewrite this query using three subqueries to optimize and reduce the Request Unit (RU) charge. Observe that the multi-value subquery always appears in the FROM clause of the outer query.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">VALUE</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> c
<span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">VALUE</span> t <span class="token keyword">FROM</span> t <span class="token operator">IN</span> c<span class="token punctuation">.</span>tags <span class="token keyword">WHERE</span> t<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'infant formula'</span><span class="token punctuation">)</span>
<span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">VALUE</span> n <span class="token keyword">FROM</span> n <span class="token operator">IN</span> c<span class="token punctuation">.</span>nutrients <span class="token keyword">WHERE</span> n<span class="token punctuation">.</span>nutritionValue <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">AND</span> n<span class="token punctuation">.</span>nutritionValue <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token keyword">VALUE</span> s <span class="token keyword">FROM</span> s <span class="token operator">IN</span> c<span class="token punctuation">.</span>servings <span class="token keyword">WHERE</span> s<span class="token punctuation">.</span>amount <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="/trainingdays/assets/img/FoodQuery11.2bb23bc8.png" alt="Food Query"></p> <p>Let's compare the Request Unit Statistics:</p> <p><img src="/trainingdays/assets/img/QueryStatslow.1b88da58.png" alt="Query Statistics"></p> <p>You should observe a lower Request Unit charge.</p> <h1 id="optional-indexing-in-azure-cosmos-db"><a href="#optional-indexing-in-azure-cosmos-db" class="header-anchor">#</a> Optional: Indexing in Azure Cosmos DB</h1> <p>In this lab, you will modify the indexing policy of an Azure Cosmos DB container. You will explore how you can optimize indexing policy for write or read heavy workloads as well as understand the indexing requirements for different SQL API query features.</p> <h4 id="indexing-overview"><a href="#indexing-overview" class="header-anchor">#</a> Indexing Overview</h4> <p>Azure Cosmos DB is a schema-agnostic database that allows you to iterate on your application without having to deal with schema or index management. By default, Azure Cosmos DB automatically indexes every property for all items in your container without the need to define any schema or configure secondary indexes. If you chose to leave indexing policy at the default settings, you can run most queries with optimal performance and never have to explicitly consider indexing. However, if you want control over adding or removing properties from the index, modification is possible through the Azure Portal or any SQL API SDK.</p> <p>Azure Cosmos DB uses an inverted index, representing your data in a tree form. For a brief introduction on how this works, read our <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/index-overview" target="_blank" rel="noopener noreferrer">indexing overview<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> before continuing with the lab.</p> <h4 id="customizing-the-indexing-policy"><a href="#customizing-the-indexing-policy" class="header-anchor">#</a> Customizing the indexing policy</h4> <p>In this lab section, you will view and modify the indexing policy for your <strong>FoodCollection</strong>.</p> <p>Open Data Explorer:</p> <ol><li><p>In the <strong>Azure Cosmos DB</strong> blade, locate and click the <strong>Data Explorer</strong> link on the left side of the blade.</p></li> <li><p>In the <strong>Data Explorer</strong> section, expand the <strong>ImportDatabase</strong> database node and then expand the <strong>FoodCollection</strong> container node.</p></li> <li><p>Within the <strong>FoodCollection</strong> node, click the <strong>Items</strong> link.</p></li> <li><p>View the items within the container. Observe how these documents have many properties, including arrays. If we do not use a particular property in the WHERE clause, ORDER BY clause, or a JOIN, indexing the property does not provide any performance benefit.</p></li> <li><p>Still within the <strong>FoodCollection</strong> node, click the <strong>Scale &amp; Settings</strong> link. In the <strong>Indexing Policy</strong> section, you can edit the JSON file that defines your container's index. Indexing policy can also be modified through any Azure Cosmos DB SDK, but during this lab we will modify the indexing policy through the Azure Portal.</p></li></ol> <h4 id="including-and-excluding-range-indexes"><a href="#including-and-excluding-range-indexes" class="header-anchor">#</a> Including and excluding Range Indexes</h4> <p>Instead of including a range index on every property by default, you can chose to either include or exclude specific paths from the index. Let's go through some simple examples (no need to enter these into the Azure Portal, we can just review them here).</p> <p>Within the <strong>FoodCollection</strong>, documents have this schema (some properties were removed for simplicity):</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;36000&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_rid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;LYwNAKzLG9ADAAAAAAAAAA==&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_self&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dbs/LYwNAA==/colls/LYwNAKzLG9A=/docs/LYwNAKzLG9ADAAAAAAAAAA==/&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;_etag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\&quot;0b008d85-0000-0700-0000-5d1a47e60000\&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;APPLEBEE'S, 9 oz house sirloin steak&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;applebee's&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;9 oz house sirloin steak&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token property">&quot;manufacturerName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Applebee's&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;foodGroup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Restaurant Foods&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;nutrients&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;301&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Calcium, Ca&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;nutritionValue&quot;</span><span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
            <span class="token property">&quot;units&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mg&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;312&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Copper, Cu&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;nutritionValue&quot;</span><span class="token operator">:</span> <span class="token number">0.076</span><span class="token punctuation">,</span>
            <span class="token property">&quot;units&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mg&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If you wanted to only index the manufacturerName, foodGroup, and nutrients array with a range index, you should define the following index policy:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
        <span class="token property">&quot;indexingMode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;consistent&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;includedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/manufacturerName/*&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/foodGroup/*&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/nutrients/[]/*&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;excludedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/*&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><img src="/trainingdays/assets/img/IndexPolicy.7066b734.png" alt="Index Policy"></p> <p>In this example, we use the wildcard character '*' to indicate that we would like to index all paths within the nutrients array. However, it's possible we may just want to index the nutritionValue of each array element.</p> <p>In this next example, the indexing policy would explicitly specify that the nutritionValue path in the nutrition array should be indexed. Since we don't use the wildcard character '*', no additional paths in the array are indexed.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
        <span class="token property">&quot;indexingMode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;consistent&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;includedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/manufacturerName/*&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/foodGroup/*&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/nutrients/[]/nutritionValue/*&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;excludedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/*&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Finally, it's important to understand the difference between the <code>*</code> and <code>?</code> characters. The <code>*</code> character indicates that Azure Cosmos DB should index every path beyond that specific node. The <code>?</code> character indicates that Azure Cosmos DB should index no further paths beyond this node. In the above example, there are no additional paths under nutritionValue. If we were to modify the document and add a path here, having the wildcard character '*'  in the above example would ensure that the property is indexed without explicitly mentioning the name.</p> <h4 id="understand-query-requirements"><a href="#understand-query-requirements" class="header-anchor">#</a> Understand query requirements</h4> <p>Before modifying indexing policy, it's important to understand how the data is used in the collection. If your workload is write-heavy or your documents are large, you should only index necessary paths. This will significantly decrease the amount of RU's required for inserts, updates, and deletes.</p> <p>Let's imagine that the following queries are the only read operations that are executed on the <strong>FoodCollection</strong> container.</p> <p><strong>Query #1</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>manufacturerName <span class="token operator">=</span> <span class="token operator">&lt;</span>manufacturerName<span class="token operator">&gt;</span>
</code></pre></div><p><strong>Query #2</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>foodGroup <span class="token operator">=</span> <span class="token operator">&lt;</span>foodGroup<span class="token operator">&gt;</span>
</code></pre></div><p>These queries only require that a range index be defined on <strong>manufacturerName</strong> and <strong>foodGroup</strong>, respectively. We can modify the indexing policy to index only these properties.</p> <h4 id="edit-the-indexing-policy-by-including-paths"><a href="#edit-the-indexing-policy-by-including-paths" class="header-anchor">#</a> Edit the indexing policy by including paths</h4> <ol><li>Navigate back to the <strong>FoodCollection</strong> in the Azure Portal and click the <strong>Scale &amp; Settings</strong> link. In the <strong>Indexing Policy</strong> section, replace the existing json file with the following:</li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
        <span class="token property">&quot;indexingMode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;consistent&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;includedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/manufacturerName/*&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/foodGroup/*&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;excludedPaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/*&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>This new indexing policy will create a range index on only the manufacturerName and foodGroup properties. It will remove range indexes on all other properties. Click <strong>Save</strong>. Azure Cosmos DB will update the index in the container, using your excess provisioned throughput to make the updates.</p> <p>During the container re-indexing, write performance is unaffected. However, queries may return incomplete results.</p> <ol><li>After defining the new indexing policy, navigate to your <strong>FoodCollection</strong> and select the <strong>Add New SQL Query</strong> icon. Paste the following SQL query and select <strong>Execute Query</strong>:</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>manufacturerName <span class="token operator">=</span> <span class="token string">&quot;Kellogg, Co.&quot;</span>
</code></pre></div><p><img src="/trainingdays/assets/img/QueryKellog.b621a76a.png" alt="Query"></p> <p>Let's look at the Request Unit Statistics:</p> <p><img src="/trainingdays/assets/img/QueryStatsIndexLow.fcafa224.png" alt="Query Statistics"></p> <p>Navigate to the <strong>Query Stats</strong> tab. You should observe that this query still has a low RU charge, even after removing some properties from the index. Because the <strong>manufacturerName</strong> was the only property used as a filter in the query, it was the only index that was required.</p> <p>Now, replace the query text with the following and select <strong>Execute Query</strong>:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> c <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>description <span class="token operator">=</span> <span class="token string">&quot;Bread, blue corn, somiviki (Hopi)&quot;</span>
</code></pre></div><p><img src="/trainingdays/assets/img/QueryCorn.5ac8c174.png" alt="Query"></p> <p>Let's compare the Request Unit Statistics:</p> <p><img src="/trainingdays/assets/img/QueryStatsIndexHigh.dd9a8a4a.png" alt="Query Statistics"></p> <p>You should observe that this query has a very high RU charge even though only a single document is returned. This is because no range index is currently defined for the <code>description</code> property.</p> <p>If a query does not use the index, the <strong>Index hit document count</strong> will be 0. We can see above that the query needed to retrieve 5,187 documents and ultimately ended up only returning 1 document.</p> <h4 id="edit-the-indexing-policy-by-excluding-paths"><a href="#edit-the-indexing-policy-by-excluding-paths" class="header-anchor">#</a> Edit the indexing policy by excluding paths</h4> <p>In addition to manually including certain paths to be indexed, you can exclude specific paths. In many cases, this approach can be simpler since it will allow all new properties in your document to be indexed by default. If there is a property that you are certain you will never use in your queries, you should explicitly exclude this path.</p> <h1 id="house-keeping-lab-cleanup"><a href="#house-keeping-lab-cleanup" class="header-anchor">#</a> House Keeping: Lab Cleanup</h1> <p>Remove the sample resource group.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ az group delete -n adc-cosmos-db-rg
</code></pre></div><h1 id="optional-cosmos-db-change-feed"><a href="#optional-cosmos-db-change-feed" class="header-anchor">#</a> Optional: Cosmos DB Change Feed</h1> <p><a href="https://github.com/CosmosDB/labs/blob/master/dotnet/labs/08-change_feed_with_azure_functions.md" target="_blank" rel="noopener noreferrer">Azure Cosmos DB Change Feed<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azuredevcollege/trainingdays/edit/master/day3/challenges/challenge-1.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/trainingdays/assets/js/app.d38bf813.js" defer></script><script src="/trainingdays/assets/js/2.5ff1d4d5.js" defer></script><script src="/trainingdays/assets/js/3.b5657a11.js" defer></script>
  </body>
</html>
