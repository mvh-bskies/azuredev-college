<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Integrate Azure AD into the SCM Contacts API | Azure Developer College</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/trainingdays/assets/css/0.styles.bc728db4.css" as="style"><link rel="preload" href="/trainingdays/assets/js/app.d38bf813.js" as="script"><link rel="preload" href="/trainingdays/assets/js/2.5ff1d4d5.js" as="script"><link rel="preload" href="/trainingdays/assets/js/39.4bf7d432.js" as="script"><link rel="prefetch" href="/trainingdays/assets/js/10.e0433817.js"><link rel="prefetch" href="/trainingdays/assets/js/11.cd8c7b17.js"><link rel="prefetch" href="/trainingdays/assets/js/12.12888c30.js"><link rel="prefetch" href="/trainingdays/assets/js/13.873bda65.js"><link rel="prefetch" href="/trainingdays/assets/js/14.1a24ee27.js"><link rel="prefetch" href="/trainingdays/assets/js/15.6fa51cf9.js"><link rel="prefetch" href="/trainingdays/assets/js/16.d5e02596.js"><link rel="prefetch" href="/trainingdays/assets/js/17.fcaa5f26.js"><link rel="prefetch" href="/trainingdays/assets/js/18.f2a21d28.js"><link rel="prefetch" href="/trainingdays/assets/js/19.a350c78d.js"><link rel="prefetch" href="/trainingdays/assets/js/20.bfd694b1.js"><link rel="prefetch" href="/trainingdays/assets/js/21.bed10b37.js"><link rel="prefetch" href="/trainingdays/assets/js/22.860246de.js"><link rel="prefetch" href="/trainingdays/assets/js/23.b225110a.js"><link rel="prefetch" href="/trainingdays/assets/js/24.13b22772.js"><link rel="prefetch" href="/trainingdays/assets/js/25.e0f5a7a3.js"><link rel="prefetch" href="/trainingdays/assets/js/26.c1146b2a.js"><link rel="prefetch" href="/trainingdays/assets/js/27.ab26807b.js"><link rel="prefetch" href="/trainingdays/assets/js/28.ab2698cc.js"><link rel="prefetch" href="/trainingdays/assets/js/29.496ec42d.js"><link rel="prefetch" href="/trainingdays/assets/js/3.b5657a11.js"><link rel="prefetch" href="/trainingdays/assets/js/30.fd15c623.js"><link rel="prefetch" href="/trainingdays/assets/js/31.72ed4ad1.js"><link rel="prefetch" href="/trainingdays/assets/js/32.81e15b13.js"><link rel="prefetch" href="/trainingdays/assets/js/33.f1fcf176.js"><link rel="prefetch" href="/trainingdays/assets/js/34.8432e852.js"><link rel="prefetch" href="/trainingdays/assets/js/35.61413aac.js"><link rel="prefetch" href="/trainingdays/assets/js/36.dc009a95.js"><link rel="prefetch" href="/trainingdays/assets/js/37.88c251fb.js"><link rel="prefetch" href="/trainingdays/assets/js/38.b9f64ed2.js"><link rel="prefetch" href="/trainingdays/assets/js/4.316442a1.js"><link rel="prefetch" href="/trainingdays/assets/js/40.a1779f5a.js"><link rel="prefetch" href="/trainingdays/assets/js/41.b4f159db.js"><link rel="prefetch" href="/trainingdays/assets/js/42.096f1aa1.js"><link rel="prefetch" href="/trainingdays/assets/js/43.cf13395f.js"><link rel="prefetch" href="/trainingdays/assets/js/44.92be7e22.js"><link rel="prefetch" href="/trainingdays/assets/js/45.298ad7f7.js"><link rel="prefetch" href="/trainingdays/assets/js/46.4d6179b3.js"><link rel="prefetch" href="/trainingdays/assets/js/47.bc41cef1.js"><link rel="prefetch" href="/trainingdays/assets/js/48.31275a9a.js"><link rel="prefetch" href="/trainingdays/assets/js/49.a2dc55f9.js"><link rel="prefetch" href="/trainingdays/assets/js/5.815c1276.js"><link rel="prefetch" href="/trainingdays/assets/js/50.c6016f95.js"><link rel="prefetch" href="/trainingdays/assets/js/51.0bd2785b.js"><link rel="prefetch" href="/trainingdays/assets/js/52.4e12987f.js"><link rel="prefetch" href="/trainingdays/assets/js/53.fb7850b1.js"><link rel="prefetch" href="/trainingdays/assets/js/54.1f20c333.js"><link rel="prefetch" href="/trainingdays/assets/js/55.d1950d56.js"><link rel="prefetch" href="/trainingdays/assets/js/56.3a6b8119.js"><link rel="prefetch" href="/trainingdays/assets/js/57.3639003b.js"><link rel="prefetch" href="/trainingdays/assets/js/58.091b6b2a.js"><link rel="prefetch" href="/trainingdays/assets/js/59.b1b6f798.js"><link rel="prefetch" href="/trainingdays/assets/js/6.6bc81206.js"><link rel="prefetch" href="/trainingdays/assets/js/60.8312cc43.js"><link rel="prefetch" href="/trainingdays/assets/js/61.8077d507.js"><link rel="prefetch" href="/trainingdays/assets/js/62.7099a9ec.js"><link rel="prefetch" href="/trainingdays/assets/js/63.de9324f4.js"><link rel="prefetch" href="/trainingdays/assets/js/64.69b552bd.js"><link rel="prefetch" href="/trainingdays/assets/js/65.7999d6d6.js"><link rel="prefetch" href="/trainingdays/assets/js/66.bd4052c9.js"><link rel="prefetch" href="/trainingdays/assets/js/67.e79e194c.js"><link rel="prefetch" href="/trainingdays/assets/js/68.f8d8015a.js"><link rel="prefetch" href="/trainingdays/assets/js/69.e5994ee8.js"><link rel="prefetch" href="/trainingdays/assets/js/7.60b45c24.js"><link rel="prefetch" href="/trainingdays/assets/js/70.55b1b75a.js"><link rel="prefetch" href="/trainingdays/assets/js/71.eba7950f.js"><link rel="prefetch" href="/trainingdays/assets/js/72.75c0fa4d.js"><link rel="prefetch" href="/trainingdays/assets/js/73.457d78aa.js"><link rel="prefetch" href="/trainingdays/assets/js/74.a278da89.js"><link rel="prefetch" href="/trainingdays/assets/js/75.8f7da85a.js"><link rel="prefetch" href="/trainingdays/assets/js/76.306b2367.js"><link rel="prefetch" href="/trainingdays/assets/js/77.4b93f5b5.js"><link rel="prefetch" href="/trainingdays/assets/js/78.149c6cba.js"><link rel="prefetch" href="/trainingdays/assets/js/79.df492d10.js"><link rel="prefetch" href="/trainingdays/assets/js/8.240e2339.js"><link rel="prefetch" href="/trainingdays/assets/js/80.91573785.js"><link rel="prefetch" href="/trainingdays/assets/js/9.6caa67cc.js">
    <link rel="stylesheet" href="/trainingdays/assets/css/0.styles.bc728db4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/trainingdays/" class="home-link router-link-active"><!----> <span class="site-name">Azure Developer College</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/trainingdays/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/trainingdays/day1/" class="sidebar-link">Day 1 Azure Fundamentals &amp; Infrastructure</a></li><li><a href="/trainingdays/day2/" class="sidebar-link">Day 2 Azure Development</a></li><li><a href="/trainingdays/day3/" class="sidebar-link">Day 3 Data and AI</a></li><li><a href="/trainingdays/day4/" class="sidebar-link">Day 4 Azure DevOps</a></li><li><a href="/trainingdays/day5/" aria-current="page" class="sidebar-link">Day 5 Identity and Architecture</a></li><li><a href="/trainingdays/day6/" class="sidebar-link">Day 6 Containerization</a></li><li><a href="/trainingdays/day7/" class="sidebar-link">Day 7 Kubernetes</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="integrate-azure-ad-into-the-scm-contacts-api"><a href="#integrate-azure-ad-into-the-scm-contacts-api" class="header-anchor">#</a> Integrate Azure AD into the SCM Contacts API</h1> <h2 id="here-is-what-you-will-learn"><a href="#here-is-what-you-will-learn" class="header-anchor">#</a> Here is what you will learn</h2> <ul><li>Create Azure AD's client and server applications to integrate Azure AD into the SCM Contacts API</li> <li>Configure and deploy the SCM Contacts API to Azure with Azure AD integration</li></ul> <p>In the previous challenges you have learned some basics about the OpenID Connect and OAuth2 flows. You have seen how you can sign in users and how to acquire an access token for an Azure AD's protected resource. In this challenge we will integrate Azure AD into the SCM Contacts API step by step. Of course we will use Azure Pipelines to build and deploy the SCM Contacts API to Azure.</p> <h2 id="create-the-azure-ad-client-and-server-application"><a href="#create-the-azure-ad-client-and-server-application" class="header-anchor">#</a> Create the Azure AD client and server application</h2> <p>In <a href="/trainingdays/day5/challenges/challenge-2.html">challenge-2</a> you have already seen how to create an Azure AD client application to sign in users and how to create an API application that exposes OAuth2 permissions. We have to do the same for the sample application.</p> <p>There are already scripts available in the repository to create both applications for you. If you want to use a Shell script you can use the script <a href="../apps/infrastructure/scripts/aad-integration.sh">day5/apps/infrastructure/scripts/aad-integration.sh</a>. If you want to use Powershell you can use the Script <a href="../apps/infrastructure/scripts/aad-integration.ps1">day5/apps/infrastructure/scripts/aad-integration.ps1</a>.</p> <p>Each script creates the server application first and then the client application for the sample application. The scripts use a <a href="../apps/infrastructure/scripts/oauth2-permissions.json">oauth2-permissions.json</a> file where all needed OAuth2 permission are defined.</p> <h3 id="shell"><a href="#shell" class="header-anchor">#</a> Shell</h3> <p>Open a shell, use Azure CLI to connect to the Azure AD Tenant where you want to create the applications:. If you have created a new Azure AD that is not linked to an Azure subscription, add the additional option <em>--allow-no-subscription</em>:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az login --allow-no-subscription
</code></pre></div><p>We have to run the script twice. Once for creating the applications for our <code>Development</code> stage and once for the <code>Testing</code> stage.
Please use the following parameters to run the script for the <code>Development</code> stage:</p> <table><thead><tr><th>Parameter</th> <th>Value</th></tr></thead> <tbody><tr><td>API-APP-NAME</td> <td>scmapi-dev</td></tr> <tr><td>API-APP-URI</td> <td>http://scmapi-dev</td></tr> <tr><td>UI-APP-NAME</td> <td>scmfe-dev</td></tr> <tr><td>UI-APP-REPLY-URL</td> <td>the url of your SCM Frontend deployment of stage <code>Development</code> (This is the Url to the static website e.g. <code>https://scmfedev.z20.web.core.windows.net</code>)</td></tr></tbody></table> <p>Use the following parameter for the <code>Testing</code> stage:</p> <table><thead><tr><th>Parameter</th> <th>Value</th></tr></thead> <tbody><tr><td>API-APP-NAME</td> <td>scmapi-test</td></tr> <tr><td>API-APP-URI</td> <td>http://scmapi-test</td></tr> <tr><td>UI-APP-NAME</td> <td>scmfe-test</td></tr> <tr><td>UI-APP-REPLY-URL</td> <td>the url of your SCM Frontend deployment of stage <code>Testing</code>(This is the Url to the static website e.g. <code>https://scmfetest.z20.web.core.windows.net</code>))</td></tr></tbody></table> <p>Navigate to the directory <a href="../apps/infrastructure/scripts">day5/apps/infrastructure/scripts</a> which contains the script and oauth2-permissions.json configuration file. Run the script twice, once for the <code>Development</code>and once for the <code>Testing</code>stage.</p> <p><strong>Note:</strong> Please note down the <code>UI AppId</code> and <code>API AppId</code> from the output after each run!</p> <div class="language- extra-class"><pre class="language-text"><code>/scripts&gt; ./aad-integration.sh &lt;API-APP-NAME&gt; &lt;API-APP-URI&gt; &lt;UI-APP-NAME&gt; &lt;UI-APP-REPLY-URL&gt;
</code></pre></div><p>The output:</p> <div class="language- extra-class"><pre class="language-text"><code>...
...
UI AppId: &lt;please note down&gt;
API AppId &lt;please note down&gt;
</code></pre></div><h3 id="powershell"><a href="#powershell" class="header-anchor">#</a> PowerShell</h3> <p>Open Powershell and connect to your Azure AD. If you have not installed the AzureAD module run the following command:</p> <div class="language-PowerShell extra-class"><pre class="language-powershell"><code><span class="token function">Install-Module</span> AzureAD
<span class="token function">Import-Module</span> AzureAD
</code></pre></div><p>Connect to your AzureAD using the command as follows:</p> <div class="language-PowerShell extra-class"><pre class="language-powershell"><code><span class="token function">Connect-AzureAD</span>
</code></pre></div><p>We have to run the script twice. Once for creating the applications for our <code>Development</code> stage and once for the <code>Testing</code> stage.
Please use the following parameters to run the script for the <code>Development</code> stage:</p> <table><thead><tr><th>Parameter</th> <th>Value</th></tr></thead> <tbody><tr><td>ApiAppName</td> <td>scmapi-dev</td></tr> <tr><td>ApiAppUri</td> <td>http://scmapi-dev</td></tr> <tr><td>UiAppName</td> <td>scmfe-dev</td></tr> <tr><td>UiAppReplyUrl</td> <td>the url of your SCM Frontend deployment of stage <code>Development</code> (This is the Url to the static website e.g. <code>https://scmfedev.z20.web.core.windows.net</code>)</td></tr></tbody></table> <p>Use the following parameter for the <code>Testing</code> stage:</p> <table><thead><tr><th>Parameter</th> <th>Value</th></tr></thead> <tbody><tr><td>ApiAppName</td> <td>scmapi-test</td></tr> <tr><td>ApiAppUri</td> <td>http://scmapi-test</td></tr> <tr><td>UiAppName</td> <td>scmfe-test</td></tr> <tr><td>UiAppReplyUrl</td> <td>the url of your SCM Frontend deployment of stage <code>Testing</code>(This is the Url to the static website e.g. <code>https://scmfetest.z20.web.core.windows.net</code>))</td></tr></tbody></table> <p>Navigate to the directory <a href="../apps/infrastructure/scripts">day5/apps/infrastructure/scripts</a> which contains the script and oauth2-permissions.json configuration file. Run the script twice, once for the <code>Development</code>and once for the <code>Testing</code>stage.</p> <p><strong>Note:</strong> Please note down the <code>UiAppId</code> and <code>ApiAppId</code> from the output after each run!</p> <div class="language-PowerShell extra-class"><pre class="language-powershell"><code><span class="token punctuation">.</span><span class="token operator">/</span>aad<span class="token operator">-</span>integration<span class="token punctuation">.</span>ps1 <span class="token operator">-</span>ApiAppName &lt;API<span class="token operator">-</span>APP<span class="token operator">-</span>NAME&gt; <span class="token operator">-</span>ApiAppUri &lt;API<span class="token operator">-</span>APP<span class="token operator">-</span>URI&gt; <span class="token operator">-</span>UiAppName &lt;UI<span class="token operator">-</span>APP<span class="token operator">-</span>NAME&gt; <span class="token operator">-</span>UiAppReplyUrl &lt;UI<span class="token operator">-</span>APP<span class="token operator">-</span>REPLY<span class="token operator">-</span>URL&gt;
</code></pre></div><p>The output:</p> <div class="language- extra-class"><pre class="language-text"><code>...
...
ApiAppId: &lt;ApiAppId&gt;
UiAppId: &lt;UiAppId&gt;
</code></pre></div><h2 id="validate-the-applications-in-azure-ad"><a href="#validate-the-applications-in-azure-ad" class="header-anchor">#</a> Validate the Applications in Azure AD</h2> <p>After you have run the script twice navigate to your Azure AD and checkout the newly created applications. You should see four new applications.</p> <h2 id="protect-scm-contacts-api-with-azure-ad"><a href="#protect-scm-contacts-api-with-azure-ad" class="header-anchor">#</a> Protect SCM Contacts API with Azure AD</h2> <blockquote><p>If you started with the checkpoint please <a href="/trainingdays/day5/apps/checkpoint/ChallengeAndBreakout.html#differences-in-challenge-3-protect-scm-contacts-api-with-azure-ad">continue here</a>.</p></blockquote> <p>Now that we have created the needed applications in Azure AD it's time to deploy the SCM Contacts API to Azure with Azure AD integration to protect the API. After the deployment the API can only be accessed with a valid access token issued by Azure AD.
Yesterday we have created CI/CD Builds for all services. Today we want to continue with Azure Pipelines to deploy all services with Azure AD integration.</p> <ol><li><p>Create and checkout a new branch named <em>features/scmcontactsaad</em> in your Azure Repo.</p> <p><strong>Note:</strong> Make sure that you create the branch in the Azure Repo where you imported the Azure Developer College's sources yesterday.</p></li> <li><p>Open the build file <code>scm-contacts-ci.yaml</code> under <code>day4/apps/pipelines</code> and change everything from <code>day4</code> to <code>day5</code></p></li> <li><p>Save the definition, commit the changes and push the branch to your remote repository</p></li> <li><p>Navigate to your Azure DevOps Project and run the pipleine <code>SCM-Contacts-CI</code> targeting the branch <code>features/scmcontactsaad</code></p></li> <li><p>Go to Releases and edit <code>SCM-Contacts-CD</code></p></li> <li><p>Add the following variables and map it to the ARM Template's parameters:</p> <table><thead><tr><th>Name</th> <th>Value</th> <th>ARM Template parameter</th> <th>Stage</th></tr></thead> <tbody><tr><td>AadInstance</td> <td>https://login.microsoftonline.com</td> <td>aadInstance</td> <td>Development</td></tr> <tr><td>AadClientId</td> <td>API AppId, the value that you received from the output when you created the Azure AD application</td> <td>aadClientId</td> <td>Development</td></tr> <tr><td>AadTenantId</td> <td>The id of your Azure AD Tenant</td> <td>aadTenantId</td> <td>Development</td></tr> <tr><td>AadDomain</td> <td>The domain name of your Azure AD e.g. azuredevcollege.onmicrosoft.com</td> <td>aadDomain</td> <td>Development</td></tr> <tr><td>AadClientIdUri</td> <td>http://scmapi-dev</td> <td>aadClientIdUri</td> <td>Development</td></tr></tbody></table> <table><thead><tr><th>Name</th> <th>Value</th> <th>ARM Template parameter</th> <th>Stage</th></tr></thead> <tbody><tr><td>AadInstance</td> <td>https://login.microsoftonline.com</td> <td>aadInstance</td> <td>Testing</td></tr> <tr><td>AadClientId</td> <td>API AppId, the value that you received from the output when you created the Azure AD application for stage Testing</td> <td>aadClientId</td> <td>Testing</td></tr> <tr><td>AadTenantId</td> <td>The id of your Azure AD Tenant</td> <td>aadTenantId</td> <td>Testing</td></tr> <tr><td>AadDomain</td> <td>The domain name of your Azure AD e.g. azuredevcollege.onmicrosoft.com</td> <td>aadDomain</td> <td>Testing</td></tr> <tr><td>AadClientIdUri</td> <td>http://scmapi-test</td> <td>aadClientIdUri</td> <td>Testing</td></tr></tbody></table> <p>ARM Template override template parameters:</p> <div class="language-Shell extra-class"><pre class="language-shell"><code>-sku <span class="token variable"><span class="token variable">$(</span>AppServicePlanSKU<span class="token variable">)</span></span> -webAppName <span class="token variable"><span class="token variable">$(</span>ApiAppName<span class="token variable">)</span></span> -use32bitworker <span class="token variable"><span class="token variable">$(</span>Use32BitWorker<span class="token variable">)</span></span> -alwaysOn <span class="token variable"><span class="token variable">$(</span>AlwaysOn<span class="token variable">)</span></span> -applicationInsightsName <span class="token variable"><span class="token variable">$(</span>ApplicationInsightsName<span class="token variable">)</span></span> -sqlServerName <span class="token variable"><span class="token variable">$(</span>SqlServerName<span class="token variable">)</span></span> -sqlUserName <span class="token variable"><span class="token variable">$(</span>SqlAdminUserName<span class="token variable">)</span></span> -sqlPassword <span class="token variable"><span class="token variable">$(</span>SqlAdminPassword<span class="token variable">)</span></span> -sqlDatabaseName <span class="token variable"><span class="token variable">$(</span>SqlDatabaseName<span class="token variable">)</span></span> -serviceBusNamespaceName <span class="token variable"><span class="token variable">$(</span>ServiceBusNamespaceName<span class="token variable">)</span></span> -aadInstance <span class="token variable"><span class="token variable">$(</span>AadInstance<span class="token variable">)</span></span> -aadClientId <span class="token variable"><span class="token variable">$(</span>AadClientId<span class="token variable">)</span></span> -aadTenantId <span class="token variable"><span class="token variable">$(</span>AadTenantId<span class="token variable">)</span></span> -aadDomain <span class="token variable"><span class="token variable">$(</span>AadDomain<span class="token variable">)</span></span> -aadClientIdUri <span class="token variable"><span class="token variable">$(</span>AadClientIdUri<span class="token variable">)</span></span>
</code></pre></div></li> <li><p>Run the release build</p></li></ol> <h2 id="validate-the-scm-contacts-api"><a href="#validate-the-scm-contacts-api" class="header-anchor">#</a> Validate the SCM Contacts API</h2> <p>Now that you have deployed the SCM Contacts API to your environment on Azure it's time to browse the Swagger UI of the API on your <em>Development</em> stage. Open the Azure portal, go to the API App and browse to the Swagger UI. Try to execute a get request. You will notice that you get back a 401:</p> <p><img src="/trainingdays/assets/img/401-swagger-contacts.26cd5589.png" alt="401 Swagger"></p> <p>That is what we expected! Your SCM Contacts API now requires a valid access token.
To acquire a valid acces token we can create a simple request as we already did in <a href="/trainingdays/day5/challenges/challenge-2.html">challenge-2</a>.</p> <p>We use the <code>Token Echo Server</code> again to request an access token from Azure AD for the SCM Contacts API. The tool is listening on port 5001 on your local machine. Tokens are accepted on the route <code>http://localhost:5001/api/tokenechofragment</code>. Before we can start the token request we have to add the url <code>http://localhost:5001/api/tokenechofragment</code> as a valid reply url to the client Azure AD application. Go to your Azure AD in the Azure portal, open the client application <code>scmfe-dev</code>that you created for the <code>Development</code> stage and add the url. You can add the reply url under <em>Authentication --&gt; Web --&gt; Redirect URIs --&gt; Add URI</em>.</p> <p><img src="/trainingdays/assets/img/tokenechoserver-redirecturl.5aa26122.png" alt="TokenEchoServer Reply Url"></p> <p>Open a shell and run the Token Echo Server from <a href="../apps/token-echo-server"><code>day5/apps/token-echo-server</code></a></p> <div class="language-Shell extra-class"><pre class="language-shell"><code>dotnet run
</code></pre></div><p>Replace <code>TENANT_ID</code> with your AAD Tenant Id and <code>APPLICATION_ID</code> with the client application's Id (this is the id <em>UI AppId</em> that you received when you created the first client application). Open a browser and paste the request:</p> <div class="language-HTTP extra-class"><pre class="language-http"><code><span class="token header-name keyword">https:</span>//login.microsoftonline.com/TENANT_ID/oauth2/v2.0/authorize?
client_id=APPLICATION_ID
&amp;response_type=id_token+token
&amp;redirect_uri=http%3A%2F%2Flocalhost%3A5001%2Fapi%2Ftokenechofragment
&amp;response_mode=fragment
&amp;scope=openid%20profile%20http%3A%2F%2Fscmapi-dev%2FContacts.Read%20http%3A%2F%2Fscmapi-dev%2FContacts.Create%20http%3A%2F%2Fscmapi-dev%2FContacts.Update%20http%3A%2F%2Fscmapi-dev%2FContacts.Delete%20http%3A%2F%2Fscmapi-dev%2FVisitReports.Create%20http%3A%2F%2Fscmapi-dev%2FVisitReports.Update%20http%3A%2F%2Fscmapi-dev%2FVisitReports.Update%20http%3A%2F%2Fscmapi-dev%2FVisitReports.Delete
&amp;nonce=1234
</code></pre></div><p>After executing the request and you have signed in, Azure AD shows you a consent page and you have to grant access for the requested API permissions.</p> <p><img src="/trainingdays/assets/img/permission-request.63f0cb0a.png" alt="Permission Request"></p> <p>After giving consent, have a look at your browser's address bar. The <code>access_token</code> is in the fragment of the url and should look something like this:</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:5001/api/tokenechofragment#access_token=eyJ0eX...&amp;token_type=Bearer&amp;expires_in=3599&amp;scope=openid+profile+User.Read+email&amp;id_token=eyJ0eXAiOi...&amp;session_state=0f76c823-eac5-4ec0-9d4a-edf40b783583
</code></pre></div><p>Make sure to only copy the <code>access_token</code>, not the full remainder of the string!</p> <p>Go to <a href="http://jwt.ms" target="_blank" rel="noopener noreferrer">https://jwt.ms<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, paste the token and have a look at the decoded token.</p> <h3 id="authorize-the-request"><a href="#authorize-the-request" class="header-anchor">#</a> Authorize the request</h3> <p>In the Swagger UI of the SCM Contacts API you see an <code>Authorize</code> button. After clicking the button you can set your valid <code>access_token</code>that is added to the authentication header with each API request.</p> <p><img src="/trainingdays/assets/img/swagger-authorize.598672ae.png" alt="Swagger Authorize"></p> <p>Add your access_token as follows:</p> <div class="language-Text extra-class"><pre class="language-text"><code>Bearer &lt;your access_token&gt;
</code></pre></div><p>Authorize the Swagger UI and retry a the GET request. If you want you can now add contacts for the signed in user.</p> <h2 id="pullrequest"><a href="#pullrequest" class="header-anchor">#</a> PullRequest</h2> <p>Create al PullRequest and merge your changes into the master branch.</p> <h2 id="wrap-up"><a href="#wrap-up" class="header-anchor">#</a> Wrap up</h2> <p>In this challenge we have adjusted our deployment process to protect the SCM Contacts API with Azure AD. ASP.NET Core comes with an Authentication Middleware that must only be configured to require a JWT Bearer token for each request. Have a look at the code and see how the Middleware is configured.
To map the required OAuth2 permission to an API Route ASP.NET Core provides an attribute where you can specify the required Policy.</p> <div class="language-C# extra-class"><pre class="language-text"><code>[Authorize(Policy = AuthorizationScopes.ContactsRead)]
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azuredevcollege/trainingdays/edit/master/day5/challenges/challenge-3.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/trainingdays/assets/js/app.d38bf813.js" defer></script><script src="/trainingdays/assets/js/2.5ff1d4d5.js" defer></script><script src="/trainingdays/assets/js/39.4bf7d432.js" defer></script>
  </body>
</html>
